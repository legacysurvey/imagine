{% extends "base.html" %}
{% load static %}

{% block header %}

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-5565065-29', 'auto');
  ga('send', 'pageview');
</script>
<link rel="stylesheet" href="{% static "leaflet-1.3.1.css" %}" />
<script src="{% static "leaflet-src-1.3.1.js" %}"></script>
{# From https://github.com/mapbox/leaflet-pip #}
<script src="{% static "leaflet-pip-20170913.js" %}"></script>
{# From https://github.com/jjimenezshaw/Leaflet.Control.Layers.Tree #}
<script src="{% static "L.Control.Layers.Tree.js" %}"></script>
<link rel="stylesheet" href="{% static "L.Control.Layers.Tree.css" %}" />
<script src="{% static "jquery-2.1.1.min.js" %}"></script>
{# From http://kartena.github.io/Leaflet.zoomslider #}
<script src="{% static "leaflet-zoomslider-0.6.1.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet-zoomslider-0.6.1.css" %}" />
{# https://github.com/jdfergason/Leaflet.Ellipse #}
<script src="{% static "l.ellipse.js" %}"></script>
<script src="{% static "utils.js" %}"></script>
<link rel="stylesheet" href="{% static "styles.css" %}" />

{% comment %}
<script src="{% static "leaflet.draw-0.2.4.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet.draw-0.2.4.css" %}" />
<script src="{% static "leaflet.measurecontrol-20150626.js" %}"></script>
<link rel="stylesheet" href="{% static "leaflet.measurecontrol-20150626.css" %}" />
{% endcomment %}
{% endblock %}

{% block body %}
<body id="thebody">
<div id="map" />

<script>
//'use strict';

 // this is just to reset the indent level for emacs javascript-mode;
 // the "{#" is a django template comment.
 {# }}} #}

// Variables from django.
var zoom_initial = {{ zoom }};
var layer_initial = '{{ layer }}';
var ra_initial = {{ ra }};
var dec_initial = {{ dec }};
var galname_initial = '{{ galname }}';
var smallcat_url = '{{ smallcaturl|safe }}';
var usercat2_url = '{{ usercatalogurl2|safe }}';
var usercat_url = '{{ usercatalogurl|safe }}';
var tile_url = '{{ tileurl|safe }}';
var maxNativeZoom = {{ maxNativeZoom }};

var abs_url = '{{ absurl }}';
var hostname_url = '{{ hostname_url }}';  // eg "http://legacysurvey.org"

var ccds_url = '{{ ccdsurl|safe }}';
var exposures_url = '{{ expsurl|safe }}';
var bricks_url = '{{ bricksurl|safe }}';
var sdss_plates_url = '{{ platesurl|safe }}';
var cat_url = '{{ caturl|safe }}';
var usercat_upload_url = '{{ uploadurl }}';
var name_query_url = '{{ namequeryurl|safe }}';

var static_tile_url = '{{ static_tile_url|safe }}';
var subdomains = {{ subdomains|safe }};

var static_tile_url_B = '{{ static_tile_url_B|safe }}';
var subdomains_B = {{ subdomains_B|safe }};

var minZoom = 1;
var maxZoom = {{ maxZoom }};

{% if enable_sql %}
var sql_url = '{{sqlurl|safe}}';
{% endif %}

// Function to search the current page URL's GET query portion URL?x=y
var QueryItems = function() {
    var terms = window.location.search.substr(1).split('&');
    var items = {};
    for (var i = 0; i < terms.length; ++i) {
        var words = terms[i].split('=');
        if (words.length == 1) {
            items[words[0]] = true;
        } else if (words.length == 2) {
            items[words[0]] = decodeURIComponent(words[1].replace(/\+/g, ' '));
        }
    }
    return items;
};
var qstr = QueryItems();

function arcsecToMeters(arcsec) {
    return arcsec * 30.87;
}

// A subclass that switches URL patterns depending on zoom range.
var ZoomRangeTileLayer = L.TileLayer.extend({
    options: {
        urlPatterns: [],
    },
	getTileUrl: function (tilePoint) {
        var urlpat = this._getUrlPattern(tilePoint.z);
		return L.Util.template(urlpat, L.extend({
			s: this._getSubdomain(tilePoint),
			z: tilePoint.z,
			x: tilePoint.x,
			y: tilePoint.y
		}, this.options));
	},
    _getUrlPattern: function (zoom) {
        var url = this._url;
        for (var i=0; i<this.options.urlPatterns.length; i++) {
            var zlo  = this.options.urlPatterns[i][0];
            var zhi  = this.options.urlPatterns[i][1];
            var zurl = this.options.urlPatterns[i][2];
            if ((zoom >= zlo) && (zoom <= zhi)) {
                url = zurl;
            }
        }
        return url;
    },
});

var SplitTileLayer = L.TileLayer.extend({

    // new SplitTileLayer(static_tile_url_B, ysplits,
    //                    north_args, mid_args, south_args);
    initialize: function(url, ysplits, north_args, mid_args, south_args) {
        this._url = url;
        this._ysplits = ysplits;
        this._north_args = north_args;
        this._mid_args = mid_args;
        this._south_args = south_args;
    },
    
	getTileUrl: function (tile) {
        var ysplit = this._ysplits[tile.z];
        // y=0 is the top!
        var urlpat;
        var opts;
        if (tile.y < ysplit) {
            opts = this._north_args;
            console.log('y', tile.y, 'zoom', tile.z, '<', ysplit, '-> north');
        } else if (tile.y > ysplit) {
            opts = this._south_args;
            console.log('y', tile.y, 'zoom', tile.z, '>', ysplit, '-> south');
        } else {
            opts = this._mid_args;
            console.log('y', tile.y, 'zoom', tile.z, '=', ysplit, '-> mid');
        }
        urlpat = this._getUrlPattern(tile.z, opts['urlPatterns']);
        //console.log('URL pattern:', urlpat);
        //console.log('opts:', opts);
		var url = L.Util.template(urlpat, L.extend({
			s: this._getSubdomain(tile),
			z: tile.z,
			x: tile.x,
			y: tile.y
		}, opts));
        console.log('-> ', url);
        return url;
	},

    _getUrlPattern: function (zoom, patterns) {
        for (var i=0; i<patterns.length; i++) {
            var zlo  = patterns[i][0];
            var zhi  = patterns[i][1];
            if ((zoom >= zlo) && (zoom <= zhi)) {
                return patterns[i][2];
            }
        }
        return this._url;
    },
});

 
// for attaching leaflet.Labels to circles
L.Circle.include(L.BaseMarkerMethods);

var CatalogOverlay = L.Evented.extend({

    initialize: function(name, pretty, kwargs) {
        //console.log('CatalogOverlay: ' + name + ',' + pretty);
        //console.log('CatalogOverlay: ' + name + ': options');
        //console.log('    ' + this.options);
        this.options = {};
        this._counter = 1;
        this._url = kwargs['url'] || smallcat_url;
        this._url_term = kwargs['urlTerm'] || name;
        this._checkbox = null;
        this._status = null;
        this._show = false;
        this._name = name;
        this._url_name = kwargs['url_name'] || this._name;
        this._dr_name  = kwargs['dr_name'] || this._url_name;
        this._url_args = kwargs['url_args'] || {};
        this._pretty = pretty;
        this._layers = {};
        this._group = L.layerGroup([]);
	    // ~ 100 arcsec
        this._radius = kwargs['radius'] || 3000;
        this._minZoom = kwargs['minZoom'] || 3;
        this._labelsMinZoom = kwargs['labelsMinZoom'] || 6;
        this._color = kwargs['color'] || '#ffffff';
        this._style = {'fillOpacity':0,
                       'weight':5,
                      };
        this._oldZoom = zoom_initial;
        map.on('overlayadd',    this.overlayAdded.bind(this));
        map.on('overlayremove', this.overlayRemoved.bind(this));
        map.on('moveend',       this.mapBoundsChanged.bind(this));
        map.on('zoomend',       this.onMapZoomEnd.bind(this));

        $(document).ready(this.ready.bind(this));
    },

    ready: function() {
        //console.log(this._name + ' ready function called');
        this._checkbox = getOverlayCheckbox(this._pretty);
        // _checkbox is a jQuery node
        //console.log('checkbox:', this._checkbox);
        if (!this._checkbox) {
            console.log('BUG line 278');
            return;
        }

        // add status span after the layer name span
        var nxt = this._checkbox.next();
        var stat = L.DomUtil.create('span', 'layer-status');
        var statid = this._name + '_status';
        stat.id = statid
        nxt.after(stat);
        nxt.after('&nbsp;');
        // find it with jQuery
        this._status = $('#' + statid);
    },

    getGroup: function() {
        return this._group;
    },

    overlayAdded: function(e) {
        if (layerMatchesEvent(this, e)) {
            console.log('overlayAdded: ' + this._name);
            this._show = true;
	        if (map.getZoom() >= this._minZoom) {
                console.log(this._name + ': LOADING!')
	            this.load();
	        }
        }
    },

    overlayRemoved: function(e) {
        if (layerMatchesEvent(this, e)) {
	        this._show = false;
            this.removeAllLayers();
        }
    },

    mapBoundsChanged: function() {
        //console.log('Map bounds changed: zoom: ' + map.getZoom());
        if (this._show && map.getZoom() >= this._minZoom) {
            this.load();
        }
    },

    onMapZoomEnd: function() {
        //console.log(this._name + ': map zoom end; oldzoom: ' + this._oldZoom +
        //', new zoom: ' + map.getZoom());
        var zoom = map.getZoom();
        if ((this._oldZoom >= this._minZoom) && (zoom < this._minZoom)) {
            //console.log(this._name + ': zoomed out past boundary');
            if (this._show) {
                //console.log(this._name + ': removing');
                // By the time we get here, onTileUnload() has already fired.
                this._show = false;
                // remove any extra ones that have stuck around (fast zoom-outs)
                this.removeAllLayers();
            }
            if (this._checkbox) {
                this._checkbox.attr('disabled', 'disabled');
            }

        } else if ((this._oldZoom < this._minZoom) && (zoom >= this._minZoom)) {
            //console.log(this._name + ': zoomed in past boundary');
            if (this._checkbox) {
                this._checkbox.removeAttr('disabled');
                if (this._checkbox.prop('checked')) {
                    // SEE layerMatchesEvent()
                    this.overlayAdded({layer:{_name:this._name}});
                }
            }
        }
        this._oldZoom = zoom;
    },

    load: function() {
        var b = map.getBounds();
        var url = L.Util.template(this._url, L.extend({
            s: subdomains[0],
	        ralo: long2ra(b.getEast()).toFixed(4),
	        rahi: long2ra(b.getWest()).toFixed(4),
	        declo: lat2dec(b.getSouth()).toFixed(4),
	        dechi: lat2dec(b.getNorth()).toFixed(4),
            id: this._url_name,
            layer: layer_name,
            ver: getcatversion(this._name),
        }, this._url_args));
        this._counter += 1;
        this._status && this._status.html('loading...');
        console.log('Loading: ' + this._name + ' for counter ' + this._counter);
        $.getJSON(url, this.loaded.bind(this, this._counter));
        console.log('Called getJSON');
    },

    loaded: function(counter, result) {
        console.log('Loaded catalog for ' + this._name);
        if (counter != this._counter) {
            console.log(this._name + ': loaded counter ' + counter + ' but ' +
                        this._counter + ' is current.');
            return;
        }
        this._status && this._status.html('');
        if (!this._show) {
            return;
        }
        var circles = this.getLayer(result);
        //console.log('Got marker layer ' + circles);
        // remove old layers
        for (var k in this._layers) {
	        if (k < counter) {
	            //console.log(this._name + ': removing previous counter ' + k);
	            this._group.removeLayer(this._layers[k]);
	            delete this._layers[k];
                //console.log(this._name + ': now contains layers:', this._group.getLayers());
	        } else {
	            console.log(this._name + ': k ' + k + ' vs counter ' + counter);
	        }
        }
        this._group.clearLayers();
        this._group.addLayer(circles);
        // save this new layer
        this._layers[counter] = circles;
        //console.log(this._name + ': saved counter ' + counter);
        this.fire('loaded', {'counter':counter, 'result':result});
    },

    removeAllLayers: function() {
        for (var key in this._layers) {
	        //console.log(this._name + ' removeAllLayers: removing ' + key);
	        var circles = this._layers[key];
	        this._group.removeLayer(circles);
	        delete this._layers[key];
        }
        this._group.clearLayers();
    },

    getLayer: function(result) {
        var showlabels = (map.getZoom() >= this._labelsMinZoom);
        var rdlist = result['rd'];
        var circleList = new Array(rdlist.length);
        var clong = map.getCenter().lng;
        var radii = result['radiusArcsec'];
        var abratio = result['abRatio'];
        var posAngle = result['posAngle'];
        var tooltipStyle = this.getTooltipStyle();
        for (var i=0, len=rdlist.length; i<len; i++) {
            var r = rdlist[i][0];
            var d = rdlist[i][1];
            var lat = dec2lat(d);
            var lng = ra2long_C(r, clong);
            var style = this._style;
            var color = this.getColor(result, i);
            if (color !== undefined) {
                style = Object.assign(style, {'color':color});
            }
            var radius = this._radius;
            if (radii) {
	            // arcsec to meters:
	            var meters = (radii[i] * 30.87) || 30;
                radius = meters;
            }
            if (abratio && posAngle) {
                var circ = L.ellipse([lat, lng], [radius,radius*abratio[i]], posAngle[i], style);
            } else {
                var circ = L.circle([lat, lng], radius, style);
            }
	        if (showlabels) {
                var txt = this.getLabel(result, i);
                if (txt.length > 0) {
                    circ.bindTooltip(txt, tooltipStyle);
                }
	        }
            var txt = this.getPopupText(result, i);
            if (txt.length > 0) {
                circ.popupText = txt;
                circ.on('click', function(e) {
                    popup.setLatLng(e.latlng)
                         .setContent(e.target.popupText)
                         .openOn(map);
                    L.DomEvent.stopPropagation(e);
                });
            }
            circleList[i] = circ;
        }
        return L.layerGroup(circleList);
    },

    getTooltipStyle() {
        return { permanent: true, interactive: true,
                 className: 'spectrumTooltip' };
    },

    getLabel: function(json, i) {
        return json['name'][i];
    },

    getPopupText: function(json, i) {
        return '';
    },
    
    getColor: function(json, i) {
        if (!('color' in json)) {
            //return undefined;
            return self._color;
        }
        return json['color'][i];
    },

    getLinkHere: function() {
        return this._url_term;
    },

    initLinkHere: function(val) {
    },

});

var BrightCatalog = CatalogOverlay.extend({
    getLabel: function(json, i) {
        var oname = json['name'][i];
        var name = oname;
        var altnames = json['altname'];
        if (altnames[i].length > 0) {
            name = name + ' (' + altnames[i] + ')';
        }
	    name = '<a href="http://simbad.u-strasbg.fr/simbad/sim-basic?Ident=' +
            oname.replace(' ','+') + '">' + name + '</a>';
        return name;
    },
});

var GalaxyCatalog = CatalogOverlay.extend({
    getLabel: function(json, i) {
        var oname = json['name'][i];
        var name = oname;
	    name = '<a href="http://simbad.u-strasbg.fr/simbad/sim-basic?Ident=' +
            oname.replace(' ','+') + '">' + name + '</a>';
        return name;
    },
});

var lslga_popup = function(json, i) {
        var ra = json['rd'][i][0];
        var dec = json['rd'][i][1];
        var name = json['name'][i];
        var pgc = json['pgc'][i];
	    s = '<a href="http://leda.univ-lyon1.fr/ledacat.cgi?o=PGC' + pgc + '">' + name + '</a>';
        // matching map/cats.py : cat_lslga
        d25 = json['radiusArcsec'][i] * 2 / 60.;
        s += '<br/>RA Dec='+ra.toFixed(6)+' '+dec.toFixed(6);
        s += '<br/>D(25)='+d25.toFixed(3)+' arcmin, b/a='+json['abRatio'][i].toFixed(2)+', PA='+json['posAngle'][i].toFixed(1)+' deg<br/>';
        z = json['redshift'][i];
        t = json['type'][i];
        if (t.length > 0)
            s += 'Type: '+t+' ';
        if (z != -1.0)
            s += ', Redshift='+z.toFixed(4);
        return s;
}

var LSLGACatalog = CatalogOverlay.extend({
    getLabel: function(json, i) {
        return lslga_popup(json, i);
    },

    getPopupText: function(json, i) {
        return lslga_popup(json, i);
    },

    getTooltipStyle() {
        return { permanent: false, interactive: true, };
    },

});

var SdssSpectraCatalog = CatalogOverlay.extend({
    getLabel: function(json, i) {
        var label = '<a href="https://dr14.sdss.org/optical/spectrum/view?mjd=' +
            json['mjd'][i] + '&fiberid=' + json['fiber'][i] + '&plateid=' +
            json['plate'][i] + '">' + json.name[i] + '</a>';
        return label;
    },

    getColor: function(json, i) {
        var label = json.name[i];
        if (label.startsWith("QSO")) {
            return "#4444ff";
        } else if (label.startsWith("GALAXY")) {
            return "#ffffff";
        } else if (label.startsWith("STAR")) {
            return "#ff4444";
        } else {
            return "#888888";
        }
    },
});

var Deep2SpectraCatalog = CatalogOverlay.extend({
    getLabel: function(json, i) {
        var label = json.name[i];
        return label;
    },
});

var DesiTargetCatalog = CatalogOverlay.extend({
    getLayer: function(result) {
        var targetids = result['targetid'];
        var rdlist = result['rd'];
        var fluxes = result['fluxes'];
        var nobs = result['nobs'];
        var labels = result['name'];
        var colors = result['color'];
        var radii = result['radius'];

        var circleList = new Array(rdlist.length);
        var clong = map.getCenter().lng;
        var zoom = map.getZoom();

        for (var i=0, len=rdlist.length; i<len; i++) {
            var r = rdlist[i][0];
            var d = rdlist[i][1];
            var lat = dec2lat(d);
            var lng = ra2long_C(r, clong);
            var color = 'blue';
            if (typeof(defaultcolor) != 'undefined') {
                color = defaultcolor;
            }
            if (colors !== undefined) {
                color = colors[i];
            }
            if (radii === undefined) {
                rad = this._radius;
            } else {
                // radius is in meters
                rad = radii[i];
                rad = arcsecToMeters(rad);
            }

            var circ = L.circle([lat, lng], rad,
                                {'color':color, 'fillOpacity':0,
                                'weight':5, 'opacity': 0.2});
            if (labels !== undefined && zoom > 13) {
                var txt = labels[i];
                if (txt.length > 0) {
                    circ.bindTooltip(txt, { permanent: true, interactive: true });
                }
            }
    
            circ.ra = r;
            circ.dec = d;
            //circ.type = typ;
            circ.fluxes = (fluxes     ? fluxes[i] : {});
            circ.nobs   = (nobs       ? nobs  [i] : {});
            circ.targetid = targetids ? targetids[i] : '';
            circ.on('click', onTargetClick);
            circleList[i] = circ;
        }
        return L.layerGroup(circleList);
    },
});

function onTargetClick(e) {
    console.log('onTargetClick');
    src = e.target;
    fluxstr = '';
    if ('g' in src.fluxes) {
        fluxstr += 'g=' + fluxToMag(src.fluxes.g).toFixed(2);
    }
    if ('r' in src.fluxes) {
        fluxstr += ', r=' + fluxToMag(src.fluxes.r).toFixed(2);
    }
    if ('z' in src.fluxes) {
        fluxstr += ', z=' + fluxToMag(src.fluxes.z).toFixed(2);
    }
    if ('W1' in src.fluxes) {
        fluxstr += ', W1=' + fluxToMag(src.fluxes.W1).toFixed(2);
    }
    if ('W2' in src.fluxes) {
        fluxstr += ', W2=' + fluxToMag(src.fluxes.W2).toFixed(2);
    }
    nobs_str = '';
    if (src.nobs) {
        nobs_g = 0
        if ('g' in src.nobs) {
    	    nobs_g = src.nobs.g;
        }
        nobs_r = 0
        if ('r' in src.nobs) {
    	    nobs_r = src.nobs.r;
        }
        nobs_z = 0
        if ('z' in src.nobs) {
    	    nobs_z = src.nobs.z;
        }
        nobs_str = '<br/>Number of exposures: g=' + nobs_g + ', r=' + nobs_r + ', z=' + nobs_z;
    }
    txt = 'Target RA,Dec = ' + src.ra.toFixed(4) + ', ' + src.dec.toFixed(4) +
        '<br/>Mags: ' + fluxstr +
        nobs_str +
        '<br/>Targetid: ' + src.targetid;
    console.log('Popup text: ' + txt);
    popup.setLatLng(e.latlng).setContent(txt).openOn(map);
    explode;
    L.DomEvent.stopPropagation(e);
}


{% if enable_phat %}
var PhatClusterCatalog = CatalogOverlay.extend({
    getLayer: function(result) {
        var rdlist = result['rd'];
        var names = result['name'];
        var mags = result['mag'];
        var vs = result['velocity'];
        var zs = result['metallicity'];
        var youngs = result['young'];

        var circleList = new Array(rdlist.length);
        var clong = map.getCenter().lng;

        for (var i=0, len=rdlist.length; i<len; i++) {
            var r = rdlist[i][0];
            var d = rdlist[i][1];
            var lat = dec2lat(d);
            var lng = ra2long_C(r, clong);
            var color = 'cyan';
            if (!youngs[i]) {
                color = 'red';
            }
            rad = this._radius;
            var circ = L.circle([lat, lng], rad,
                                {'color':color, 'fillOpacity':0, 'weight':5});

            circ.bindTooltip(names[i], { permanent: true, interactive: true });
    
            circ.ra = r;
            circ.dec = d;
            circ.name = names[i];
            circ.mag = mags[i];
            circ.velocity = vs[i];
            circ.metallicity = zs[i];
            circ.on('click', function(e) {
                src = e.target;
                var text = src.name;
                text += '<br>Mag: ' + src.mag.toFixed(3);
                //var text = names[i];
                //if (vs[i] != 0.0) {
                if (src.velocity != 0.0) {
                    text += '<br>Velocity: ' + src.velocity.toFixed(1) + ' km/s';
                }
                z = src.metallicity;
                if (z != 0.0) {
                    text += '<br>Metallicity: ' + z.toFixed(3);
                }
                popup.setLatLng(e.latlng).setContent(text).openOn(map);
                L.DomEvent.stopPropagation(e);
            });
            circleList[i] = circ;
        }
        return L.layerGroup(circleList);
    },
});
{% endif %}


{% if enable_ps1 %}
var Ps1CatalogOverlay = CatalogOverlay.extend({
    getLabel: function(json, i) {
        //return '';
        var label = json.name[i];
        return label;
    },
});
{% endif %}

function layerMatchesEvent(layer, event) {
    return (layer._name == event.layer._name);
}

var TileWatcher = L.Evented.extend({

    initialize: function() {
        // string keys z:x:y of currently visible tiles
        this._visibleTiles = {};
    },

    listenToLayer: function(layer) {
        layer.on('tileloadstart', this.tileLoadStart.bind(this));
        layer.on('tileunload',    this.tileUnload.bind(this));
    },

    tileLoadStart: function(e) {
        var coord = e.coords;
        var x = coord.x;
        var zoom = coord.z;
        var maxtile = 1 << zoom;
        // In leaflet-1.2.0, x can be > 2**zoom
        x = x % maxtile;
        var key = '' + zoom + ':' + x + ':' + coord.y;
        //console.log('Tile load start: ' + key);
        if (key in this._visibleTiles) {
            //console.log('tile was already in visible tiles');
        } else {
            e.key = key;
            //console.log('firing tilevisible: ' + key);
            this._visibleTiles[key] = true;
            // A tile became visible
            this.fire('tilevisible', e);
        }
    },

    tileUnload: function(e) {
        var tile = e.tile;
        var key = '' + tile.z + ':' + tile.tilex + ':' + tile.tiley;
        //console.log('Tile unload: ' + key);
        delete this._visibleTiles[key];
        e.key = key;
        // A tile became invisible
        this.fire('tileinvisible', e);
    },

});

var TiledOverlay = CatalogOverlay.extend({

    initialize: function(tw, name, pretty, kwargs) {
        CatalogOverlay.prototype.initialize.call(this, name, pretty, kwargs);
        // count of how many tile loads are outstanding
        this._loadingTiles = 0;
        this._tw = tw;
        tw.on('tilevisible', this.tileVisible.bind(this));
        tw.on('tileinvisible', this.tileInvisible.bind(this));
    },

    tileVisible: function(e) {
        if (!this._show) {
            return;
        }
        console.log('Layer ' + this._name + ': tile visible');
        var tile = e.tile;
        //console.log('tileVisible: tile ' + tile);
        if (tile.z === undefined) {
            return;
        }
        if (tile.z < this._minZoom) {
            return;
        }
        //console.log('tileVisible: z ' + tile.z + ', x,y ' + tile.tilex + ',' + tile.tiley);
        this.load(tile.z, tile.tilex, tile.tiley);
    },

    load: function(zoom, x, y) {
        //console.log('Loading tiled catalog: URL pattern: ' + this._url +
        //            ' x,y,zoom: ' + x + ',' + y + ', ' + zoom);
        var s = getSubdomain(x, y);
	    var url = L.Util.template(this._url, L.extend({
            s: s,
            z: zoom,
            x: x,
            y: y,
            id: this._url_name,
            ver: getcatversion(this._name),
	    }));
        this._loadingTiles += 1;
        this.setStatusText();
        $.getJSON(url, this.loaded.bind(this, zoom, x, y));
    },

    setStatusText: function() {
        if (this._loadingTiles == 0) {
            this._status && this._status.html('');
        } else {
            this._status && this._status.html('loading ' + this._loadingTiles
                                              + '...');
        }
    },

    tileInvisible: function(e) {
        var key = e.key;
        if (!(key in this._layers)) {
            return;
        }
        var circles = this._layers[key];
        this._group.removeLayer(circles);
    },

    // override superclass
    mapBoundsChanged: function() {
    },

    overlayAdded: function(e) {
        if (!layerMatchesEvent(this, e)) {
            return;
        }
        console.log('overlayAdded: ' + this._name);
        this._show = true;
	    if (map.getZoom() < this._minZoom) {
            return;
        }
        // load all visible tiles
        for (var key in this._tw._visibleTiles) {
            // parse into zoom:x:y
            var words = key.split(':');
            var zoom = parseInt(words[0]);
            var x = parseInt(words[1]);
            var y = parseInt(words[2]);
            this.load(zoom, x, y);
        }
    },
    
    loaded: function(zoom, tilex, tiley, result) {
        //console.log('Loaded: zoom ' + zoom + ' x,y ' + tilex + ',' + tiley);
        // waiting for how many tiles now?
        this._loadingTiles -= 1;
        this.setStatusText();
        if (!this._show) {
            console.log('not shown');
            return;
        }
        var circles = this.getLayer(result);
        this._group.addLayer(circles);
        // save this new layer
        var key = ''+zoom+':'+tilex+':'+tiley;
        this._layers[key] = circles;
        this.fire('loaded', {'zoom':zoom, 'x':tilex, 'y':tiley, 'result':result});
    },
});

var decals_getLayer = function(result, radius, defaultcolor) {
    var rdlist = result['rd'];
    var objtype = result['sourcetype'];
    var fluxes = result['fluxes'];
    var nobs = result['nobs'];
    var bricknames = result['bricknames'];
    var objids = result['objids'];
    var labels = result['names'];
    var circleList = new Array(rdlist.length);
    var clong = map.getCenter().lng;
    var radii = result['radius'];
    var colors = result['color'];

    var abratios = result['abratio'];
    var posangles = result['posangle'];
    
    for (var i=0, len=rdlist.length; i<len; i++) {
        var r = rdlist[i][0];
        var d = rdlist[i][1];
        var lat = dec2lat(d);

        //console.log('RA,Dec ' + r + ', ' + d);

        var lng = ra2long_C(r, clong);
        var color = 'blue';
        if (typeof(defaultcolor) != 'undefined') {
            color = defaultcolor;
        }
        var typ = 'nil';
        if (colors !== undefined) {
            color = colors[i];
        } else if (objtype !== undefined) {
            typ = objtype[i];
            // PSF
            if (objtype[i] == 'P') {
                color = '#9AFE2E'; //#D8F781'; //'green';
            } else if ((objtype[i] == 'S') || (objtype[i] == 'R')) {
	            // Simple / Rex
                color = 'orange';
                //if (objtype[i] == 'S') {
            } else if (objtype[i] == 'D') {
                color = 'red';
            } else if (objtype[i] == 'E') {
                color = '#58ACFA'; // blue
            } else if (objtype[i] == 'C') {
                color = '#DA81F5'; // magenta
            }
        }
        if (radii === undefined) {
            rad = radius;
        } else {
            // radius is in meters
            rad = radii[i];
        }
        //console.log('Lat,Long,Radius ' + lat + ', ' + lng + ', ' + rad);
        rad = arcsecToMeters(rad);

        if ((abratios === undefined) || (posangles === undefined)) {
            var circ = L.circle([lat, lng], rad,
                                {'color':color, 'fillOpacity':0, 'weight':5});
        } else {
            var circ = L.ellipse([lat, lng], [rad, rad*abratios[i]], posangles[i],
                                 {'color':color, 'fillOpacity':0, 'weight':5});
        }
        if (labels === undefined) {
        } else {
            var txt = labels[i];
            if (txt.length > 0) {
                circ.bindTooltip(txt, { permanent: true, interactive: true });
            }
        }

        circ.ra = r;
        circ.dec = d;
        circ.type = typ;
        circ.fluxes = (fluxes ? fluxes[i] : {});
        circ.nobs   = (nobs   ? nobs  [i] : {});
        circ.brickname = bricknames ? bricknames[i] : '';
        circ.objid     = objids     ? objids    [i] : '';
        circ.on('click', onSourceClick);
        circleList[i] = circ;
    }
    return L.layerGroup(circleList);
};

// DECaLS catalog
var DecalsCatalogLayer = TiledOverlay.extend({
    getLayer: function(result) {
        return decals_getLayer(result, 1);
    },
});

// User catalog

var userCatN = 100;

var UserCatalogLayer = CatalogOverlay.extend({
    initialize: function(name, pretty, kwargs) {
        CatalogOverlay.prototype.initialize.call(this, name, pretty, kwargs);
        this.color = '#00ff00';
        this._catname = this._url_args['cat'];
        this._catdata = null;
        this._catindex = 0;
        this._catoffset = 0;
    },

    ready: function() {
        console.log(this._name + ' ready function called (UserCatalogLayer)');
        this._checkbox = getOverlayCheckbox(this._pretty);
        // _checkbox is a jQuery node
        //console.log('checkbox:', this._checkbox);
        var nxt = this._checkbox.next();

        // add a 'next' button after the layer name span
        var nextbutton = L.DomUtil.create('a', 'layer-next');
        var nextbuttonid = this._name + '_next';
        nextbutton.id = nextbuttonid;
        nxt.after(nextbutton);
        nxt.after('&nbsp;');
        // find it with jQuery
        var jbutton = $('#' + nextbuttonid);
        jbutton.attr('href', '#');
        jbutton.click(this.nextObject.bind(this));
        jbutton.html('next');

        // catalog index
        var indx = L.DomUtil.create('span', 'layer-index');
        var indxid = this._name + '_indx';
        indx.id = indxid;
        nxt.after(indx);
        nxt.after('&nbsp;');
        // find it with jQuery
        this._index = $('#' + indxid);
        this._index.html('[' + (this._catoffset + this._catindex) + ']');

        // prev catalog entry
        var prevbutton = L.DomUtil.create('a', 'layer-prev');
        var prevbuttonid = this._name + '_prev';
        prevbutton.id = prevbuttonid;
        nxt.after(prevbutton);
        nxt.after('&nbsp;');
        // find it with jQuery
        var jbutton = $('#' + prevbuttonid);
        jbutton.attr('href', '#');
        jbutton.click(this.prevObject.bind(this));
        jbutton.html('prev');

        // add status span after the layer name span
        var stat = L.DomUtil.create('span', 'layer-status');
        var statid = this._name + '_status';
        stat.id = statid
        nxt.after(stat);
        nxt.after('&nbsp;');
        // find it with jQuery
        this._status = $('#' + statid);

    },

    nextObject: function() {
      console.log('next object for catalog ' + this._catname);
      if (this._catdata != null) {
        this._catindex += 1;
        console.log('catalog index now ', this._catindex);
        if (this._catindex >= this._catdata.length) {
          console.log('index exceeds catalog length: ' + this._catdata.length);
          this._catoffset += this._catdata.length;
          this._catindex = -1;
        } else {
          this._index.html('[' + (this._catoffset + this._catindex) + ']');
          ra  = this._catdata[this._catindex][0];
          dec = this._catdata[this._catindex][1];
          console.log('New RA,Dec ' + ra + ', ' + dec);
          lat = dec2lat(dec);
          lng = ra2long_C(ra, 0);
          map.panTo(L.latLng(lat,lng));
          return;
        }
      }

      // retrieve next chunk.

      var url = L.Util.template(usercat2_url, {
        s: subdomains[0],
        cat: this._catname,
        start: this._catoffset,
        N: userCatN,
      });
      console.log('Loading catalog: ' + this._catname + ' from ' + url);
      $.getJSON(url, this.catLoaded.bind(this, true));
    },

    prevObject: function() {
      console.log('prev object for catalog ' + this._catname);
      if (this._catindex + this._catoffset < 0) {
        // don't go negative
        return;
      }
      if (this._catdata != null) {
        this._catindex -= 1;
        console.log('catalog index now ', this._catindex);
        if (this._catindex < 0) {
          console.log('index negative');
          this._catoffset -= this._catdata.length;
          this._catindex = -1;
        } else {
          this._index.html('[' + (this._catoffset + this._catindex) + ']');
          ra  = this._catdata[this._catindex][0];
          dec = this._catdata[this._catindex][1];
          console.log('New RA,Dec ' + ra + ', ' + dec);
          lat = dec2lat(dec);
          lng = ra2long_C(ra, 0);
          map.panTo(L.latLng(lat,lng));
          return;
        }
      }

      // retrieve prev chunk.
      var url = L.Util.template(usercat2_url, {
        s: subdomains[0],
        cat: this._catname,
        start: this._catoffset,
        N: userCatN,
      });
      console.log('Loading catalog: ' + this._catname + ' from ' + url);
      $.getJSON(url, this.catLoaded.bind(this, false));
    },

    catLoaded: function(nxt, result) {
      console.log('User catalog loaded: ' + this._catname);
      this._catdata = result['rd'];
      if (nxt) {
        this.nextObject();
      } else {
        this._catindex = this._catdata.length;
        this.prevObject();
      }
    },

    getLayer: function(result) {
        return decals_getLayer(result, 10, this.color);
    },
});

{% if enable_sql %}
var SqlCatalogOverlay = CatalogOverlay.extend({

    initialize: function(name, pretty, kwargs) {
        CatalogOverlay.prototype.initialize.call(this, name, pretty, kwargs);
        this._jsonQuery = null;
    },

    newQuery: function() {
        this._show = true;
        this.load();
    },

    overlayAdded: function() {
    },

    ready: function() {
        // find it with jQuery
        this._status = $('#sqlquery_status');
    },

    load: function() {
        if (this._jsonQuery) {
            this._jsonQuery.abort();
        }
        var sqlQueryString = $('#sqlquery').val();
        var b = map.getBounds();
        var url = L.Util.template(this._url, L.extend({
            s: subdomains[0],
	        east: long2ra(b.getEast()).toFixed(4),
	        west: long2ra(b.getWest()).toFixed(4),
	        south: lat2dec(b.getSouth()).toFixed(4),
	        north: lat2dec(b.getNorth()).toFixed(4),
            q: sqlQueryString,
        }));
        this._counter += 1;
        this._status && this._status.html('loading...');
        this._jsonQuery =$.getJSON(url, this.loaded.bind(this, this._counter));
    },

    getLabel: function(json, i) {
        return '';
    },

});
{% endif %}

function getkeys(obj) {
    var s = '';
    for (var k in obj) {
        if (s.length) {
            s += ', ';
        }
        s += k;
    }
    return s;
}

function getSubdomain(x,y) {
	return subdomains[Math.abs(x + y) % subdomains.length];
}

function fluxToMag(f) {
    return -2.5 * (Math.log(f)/Math.log(10.) - 9);
}

function cutout_radec_url(ra, dec) {
    return '{% url 'cutouts' %}?ra=' + ra.toFixed(4) + '&dec=' + dec.toFixed(4) + '&layer=' + layer_name;
}

function cutout_radec_link(ra, dec) {
    {% if enable_cutouts %}
    url = cutout_radec_url(ra, dec);
    return '<a href="' + url + '">' +
        ra.toFixed(4) + ', ' + dec.toFixed(4) + '</a>';
    {% else %}
    return ra.toFixed(4) + ', ' + dec.toFixed(4);
    {% endif %}
}

function onSourceClick(e) {
    console.log('onSourceClick');
    src = e.target;
    fluxstr = '';
    if ('g' in src.fluxes) {
        fluxstr += 'g=' + fluxToMag(src.fluxes.g).toFixed(2);
    }
    if ('r' in src.fluxes) {
        fluxstr += ', r=' + fluxToMag(src.fluxes.r).toFixed(2);
    }
    if ('z' in src.fluxes) {
        fluxstr += ', z=' + fluxToMag(src.fluxes.z).toFixed(2);
    }
    nobs_g = 0
    if ('g' in src.nobs) {
	    nobs_g = src.nobs.g;
    }
    nobs_r = 0
    if ('r' in src.nobs) {
	    nobs_r = src.nobs.r;
    }
    nobs_z = 0
    if ('z' in src.nobs) {
	    nobs_z = src.nobs.z;
    }
    txt = 'Source RA,Dec = ' + cutout_radec_link(src.ra, src.dec) +
        '<br/>Source type: ' + src.type +
        '<br/>Mags: ' + fluxstr +
        '<br/>Brick: ' + src.brickname + ', Objid: ' + src.objid +
	    '<br/>Number of exposures: g=' + nobs_g + ', r=' + nobs_r + ', z=' + nobs_z;
    console.log('Popup text: ' + txt);
    popup.setLatLng(e.latlng).setContent(txt).openOn(map);
    L.DomEvent.stopPropagation(e);
}

function brick_detail(ovname, name, aparams) {
    return 'Brick: <a href="{% url 'brick_detail_blank' %}' + name
        + '/?layer=' + layer_name + '">' + name + '</a>';
}

function ccd_detail(layer_name, name, aparams) {
    return 'CCD: <a href="{% url 'ccd_detail_blank' %}' + layer_name + '/'
                     + name.replace(' ','-')
                     + '/"' + aparams + '>' + name + '</a>';
}

function sdss_ccd_detail(layer_name, name, aparams) {
    // HACK -- name is 'SDSS R/C/F ##/##/##' -- parse!
    var words = name.split(' ');
    var rcf = words[2].split('/');
    var run = rcf[0];
    var camcol = rcf[1];
    var field = rcf[2];
    return 'CCD: <a href="https://dr12.sdss.org/fields/runCamcolField?run='
          + run + '&camcol=' + camcol + '&field=' + field
          + '"' + aparams + '>' + name + '</a>';
}

function exp_detail(layer_name, name, aparams) {
    return 'Exposure: <a href="{% url 'exp_detail_blank' %}' + layer_name + '/' +
        name.replace(' ','-') + '/"' + aparams + '>' + name + '</a>';
}

function plate_detail(layer_name, name, aparams) {
    //console.log('Plate_detail: ' + layer_name + ', ' + name + ', ' + aparams);
    return '<a href="https://dr14.sdss.org/optical/spectrum/search?plateid=' + name + '&action=search"' + aparams + '>Plate ' + name + '</a>';
}

function onMapClick(e) {
    var ra  = long2ra(e.latlng.lng);
    var dec = lat2dec(e.latlng.lat);

    var radecstr = 'ra=' + ra.toFixed(4) + '&dec=' + dec.toFixed(4);
    var linkqstr = radecstr + '&zoom=' + map.getZoom() + '&layer=' + layer_name;

    var cutout = hostname_url + '{% url 'cutout-jpeg' %}?' + linkqstr;
    var linkurl = abs_url + '?' + linkqstr;
    if ('plate' in qstr) {
        linkurl += '&plate=' + qstr['plate'];
    }

    for (var i=0,len=overlays.length; i<len; i++) {
        console.log('Overlay ' + overlays[i]._name + ' shown? ' + overlays[i]._show);
        if (overlays[i]._show) {
            linkurl += '&' + overlays[i].getLinkHere()
        }
    }

    var discuss = 'http://discuss.legacysurvey.org/new-topic?title=Interesting+object&body=' +
        '%3Cimg+src%3D%22' + encodeURIComponent(cutout) + '%22%3E' +
        '%0A' +
        encodeURIComponent(linkurl) +
        '&category=Interesting+things';

    var datalink = '{% url 'data_for_radec' %}?' + radecstr + '&layer=' + layer_name;
    var spacer = ' &nbsp;|&nbsp; ';

    var txt =
        'RA,Dec = ' + ra.toFixed(4) + ', ' + dec.toFixed(4) +
        '<br/><a href="' + linkurl +
        '">Link Here</a>' + spacer +
        '<a href="' + discuss + '">Discuss This Object</a>';

    for (var i=0; i<polygonOverlays.length; i++) {
        var overlay = polygonOverlays[i];
        var objs = overlay.under(e.latlng);
        for (var j=0; j<objs.length; j++) {
            txt += '<br/>' + overlay._detail(overlay._url_name, objs[j], '');
        }
    }

    popup.setLatLng(e.latlng).setContent(txt).openOn(map);
}

function onMouseMove(e) {
    //console.log('mouse move: ' + e.latlng);
    var ra  = long2ra(e.latlng.lng);
    var dec = lat2dec(e.latlng.lat);
    lastLatLng = e.latlng;
    if (infoBoxActive) {
	    info._div.innerHTML = 'RA,Dec = ' + ra.toFixed(4) + ", " + dec.toFixed(4) + ", zoom " + map.getZoom();
	    //+ ', lat,long ' + e.latlng.lat.toFixed(3) + ',' + e.latlng.lng.toFixed(3);
    }
    if (inbrickccdAdded) {
        inbrickccdUpdate(e);
    }
}

function inbrickccdUpdate(props) {
    if (props == undefined) {
        props = { 'latlng': lastLatLng };
    }
    if (!inbrickccdAdded) {
        inbrickccdAdded = true;
        inbrickccd.addTo(map);
    }

    var txt = '';
    for (var i=0; i<polygonOverlays.length; i++) {
        var overlay = polygonOverlays[i];
        if (overlay._detail_list == undefined) {
            continue;
        }
        var objs = overlay.under(props.latlng);
        txt += overlay._detail_list(overlay, objs);
    }
                                      
    inbrickccd._div.innerHTML = txt;
}


// "Bricks", "CCDs", etc button checked
function overlayAdded(e) {
    //console.log('OverlayAdded:', e);
    //console.log('  overlay name: ' + e.layer._name);
    if (inbrickccdAdded) {
        return;
    }
    for (var i=0; i<polygonOverlays.length; i++) {
        if (polygonOverlays[i]._show) {
            inbrickccdAdded = true;
            inbrickccd.addTo(map);
            break;
        }
    }
}

// "Sources", "Bricks", "CCDs" button unchecked
function overlayRemoved(e) {
    if (!inbrickccdAdded) {
        return;
    }
    var show = false;
    for (var i=0; i<polygonOverlays.length; i++) {
        if (polygonOverlays[i]._show) {
            show = true;
        }
    }
    if (!show) {
        map.removeControl(inbrickccd);
        inbrickccdAdded = false;
    }
}

// List of bricks / CCDs under the mouse position
var inbrickccd = L.control({'position': 'bottomleft'});
inbrickccd.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'inbrickccd');
    return this._div;
};
var inbrickccdAdded = false;

var map = L.map('map', {zoomsliderControl: false});
var popup = L.popup();

map.attributionControl.options.prefix = map.attributionControl.options.prefix +
        ' | <a href="http://github.com/legacysurvey/decals-web">Source</a>';

// default to 1.
var tileversions = {
    'sfd':2,
    'mzls+bass-dr4': 2,
    'mzls+bass-dr4-model': 2,
    'mzls+bass-dr4-resid': 2,
    'decaps2': 2,
    'decaps2-model': 2,
    'decaps2-resid': 2,
    'decaps': 2,
    'decaps-model': 2,
    'decaps-resid': 2,
};
var catversions  = {
};

function getversion(layer) {
    if (layer in tileversions) {
        return tileversions[layer];
    }
    return 1;
}

function getcatversion(layer) {
    if (layer in catversions) {
        return catversions[layer];
    }
    return 1;
}

var allLayers = [];

var decals_attrib = '<a href="http://legacysurvey.org">Legacy Survey</a>,' +
    '<a href="https://www.noao.edu/image_gallery/copyright.html">&copy;</a>' +
    ' <a href="http://noao.edu">NOAO</a>/<a href="http://www.aura-astronomy.org/">AURA</a>/<a href="http://www.nsf.gov/">NSF</a>';
var sdss_attrib = '<a href="http://sdss.org/collaboration/#image-use">(c)</a> <a href="http://sdss.org">Sloan Digital Sky Survey SDSS</a>';

var ps1_attrib = 'Pan-STARRS1';

var mylayer = function (name, pretty, kwargs) {
    var args = {
        maxZoom: maxZoom,
        minZoom: minZoom,
        maxNativeZoom: maxNativeZoom,
        attribution: decals_attrib,
        id: name,
        ver: getversion(name),
        unloadInvisibleTiles: true,
        subdomains: subdomains,
    };
    for (var key in kwargs) {
        args[key] = kwargs[key];
    }
    var tiles = new ZoomRangeTileLayer(static_tile_url, args);
    tiles.name = name;
    tiles.pretty = pretty;
    return tiles;
};

var tiles;

var defaultTile = null;

var mylayer_B = function (name, pretty, kwargs) {
    var args = {
        maxZoom: maxZoom,
        minZoom: minZoom,
        maxNativeZoom: maxNativeZoom,
        attribution: decals_attrib,
        id: name,
        ver: getversion(name),
        unloadInvisibleTiles: true,
        subdomains: subdomains_B,
    };
    for (var key in kwargs) {
        args[key] = kwargs[key];
    }
    var tiles = new ZoomRangeTileLayer(static_tile_url_B, args);
    tiles.name = name;
    tiles.pretty = pretty;
    return tiles;
};

function split_layer(name, pretty, decsplit,
                     north_name, north_urls,
                     mid_name,   mid_urls,
                     south_name, south_urls) {
    var args = {
        maxZoom: maxZoom,
        minZoom: minZoom,
        maxNativeZoom: maxNativeZoom,
        attribution: decals_attrib,
        unloadInvisibleTiles: true,
        subdomains: subdomains_B,
    };
    var north_args = Object.assign(
        {},
        args,
        { id: north_name, ver: getversion(north_name) },
        { urlPatterns: north_urls});
    var mid_args = Object.assign(
        {},
        args,
        { id: mid_name, ver: getversion(mid_name) },
        { urlPatterns: mid_urls});
    var south_args = Object.assign(
        {},
        args,
        { id: south_name, ver: getversion(south_name) },
        { urlPatterns: south_urls});

    //console.log('split_layer: north', north_args, 'mid', mid_args, 'south', south_args);
    
    var ysplits = {};
    for (var zoom=0; zoom<20; zoom++) {
        // Thanks, https://en.wikipedia.org/wiki/Web_Mercator
        y = Math.pow(2, zoom) / (2. * Math.PI) *
            (Math.PI - Math.log(Math.tan(Math.PI/4. + (Math.PI / 180. * decsplit) / 2.)));
        ysplits[zoom] = Math.floor(y);
        console.log('Dec split', decsplit, 'zoom', zoom, '-> y', ysplits[zoom]);
    }
    var tiles = new SplitTileLayer(static_tile_url_B, ysplits,
                                   north_args, mid_args, south_args);
    tiles.name = name;
    tiles.pretty = pretty;
    return tiles;
};
                                            
tiles = mylayer_B('des-dr1', 'DES DR1',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);


{% if enable_dr8 %}
tiles = split_layer('dr8', 'LegacySurvey DR8 images',
                    32.375,
                    // North
                    'dr8-north', [ [1, maxZoom, tile_url], ],
                    // Mid
                    'dr8', [ [1, maxZoom, tile_url], ],
                    // South
                    'dr8-south', [ [1, maxZoom, tile_url], ]
                   );
allLayers.push(tiles);
{% if enable_dr8_models %}
tiles = split_layer('dr8-model', 'LegacySurvey DR8 models',
                    32.375,
                    // North
                    'dr8-north-model', [ [1, maxZoom, tile_url], ],
                    // Mid
                    'dr8-model', [ [1, maxZoom, tile_url], ],
                    // South
                    'dr8-south-model', [ [1, maxZoom, tile_url], ]
                   );
allLayers.push(tiles);
{% endif %}
{% if enable_dr8_resids %}
tiles = split_layer('dr8-resid', 'LegacySurvey DR8 residuals',
                    32.375,
                    // North
                    'dr8-north-resid', [ [1, maxZoom, tile_url], ],
                    // Mid
                    'dr8-resid', [ [1, maxZoom, tile_url], ],
                    // South
                    'dr8-south-resid', [ [1, maxZoom, tile_url], ]
                   );
allLayers.push(tiles);
{% endif %}
{% endif %}

{% if enable_dr8_north %}
tiles = mylayer_B('dr8-north', 'Legacy Surveys DR8-north images',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% if enable_dr8_north_models %}
tiles = mylayer_B('dr8-north-model', 'Legacy Surveys DR8-north models',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% if enable_dr8_north_resids %}
tiles = mylayer_B('dr8-north-resid', 'Legacy Surveys DR8-north residuals',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% endif %}

{% if enable_dr8_south %}
tiles = mylayer_B('dr8-south', 'Legacy Surveys DR8-south images',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% if enable_dr8_south_models %}
tiles = mylayer_B('dr8-south-model', 'Legacy Surveys DR8-south models',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% if enable_dr8_south_resids %}
tiles = mylayer_B('dr8-south-resid', 'Legacy Surveys DR8-south residuals',
                  {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% endif %}


{% if enable_dr67 %}
tiles = split_layer('ls-dr67', 'LegacySurvey DR6+DR7 images',
                    32.,
                    // North
                    'mzls+bass-dr6', [ [13, maxZoom, tile_url], ],
                    // Mid
                    'ls-dr67', [ [14, maxZoom, tile_url], ],
                    // South
                    'decals-dr7', [ [11, maxZoom, tile_url], ]
                   );
allLayers.push(tiles);
{% endif %}

testLayers = [];
{% if enable_dev %}
{% for name,pretty in test_layers %}
  tiles = mylayer_B('{{name}}', '{{pretty}}',
                    {'urlPatterns': [ [1, maxZoom, tile_url], ],});
  allLayers.push(tiles);
  testLayers.push(tiles);
{% endfor %}
{% endif %}


{% if enable_dr6 %}
tiles = mylayer_B('mzls+bass-dr6', 'MzLS+BASS DR6 images',
                {'urlPatterns': [ [13, maxZoom, tile_url], ],});
allLayers.push(tiles);
if (defaultTile == null) {
    defaultTile = tiles;
}

{% if enable_dr6_models %}
tiles = mylayer_B('mzls+bass-dr6-model', 'MzLS+BASS DR6 models',
                  {'urlPatterns': [ [13, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
                                            
{% if enable_dr6_resids %}
tiles = mylayer_B('mzls+bass-dr6-resid', 'MzLS+BASS DR6 residuals',
                  {'urlPatterns': [ [13, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% endif %}

{% if enable_dr5 %}
tiles = mylayer_B('decals-dr5', 'DECaLS DR5 images',
                  {'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
if (defaultTile == null) {
    defaultTile = tiles;
}

{% if enable_dr5_models %}
tiles = mylayer_B('decals-dr5-model', 'DECaLS DR5 models',
                  {'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}

{% if enable_dr5_resids %}
tiles = mylayer_B('decals-dr5-resid', 'DECaLS DR5 residuals',
                {'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% endif %}

{% if enable_dr4 %}
tiles = mylayer_B('mzls+bass-dr4', 'MzLS+BASS DR4 images',
                {'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
if (defaultTile == null) {
    defaultTile = tiles;
}

{% if enable_dr4_models %}
tiles = mylayer_B('mzls+bass-dr4-model', 'MzLS+BASS DR4 models',
                  {'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
                                            
{% if enable_dr4_resids %}
tiles = mylayer_B('mzls+bass-dr4-resid', 'MzLS+BASS DR4 residuals',
                  {'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}
{% endif %}

{% if enable_decaps %}
tiles = mylayer_B('decaps', 'DECaPS images',
                  {//'maxNativeZoom': 13,
                   'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);

tiles = mylayer_B('decaps-model', 'DECaPS models',
                  {//'maxNativeZoom': 13,
                   'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
tiles = mylayer_B('decaps-resid', 'DECaPS residuals',
                  {//'maxNativeZoom': 13,
                   'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}

{% if enable_eboss %}
tiles = mylayer('eboss', 'special eBOSS region',
                {'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}

{% if enable_phat %}
tiles = mylayer('phat', 'PHAT image',
                  {'attribution': 'PHAT collaboration',
                   'urlPatterns': [ [1, maxZoom, tile_url], ],
                   'maxNativeZoom': maxZoom,});
allLayers.push(tiles);
{% endif %}

{% if enable_m33 %}
tiles = mylayer_B('m33', 'M33 image',
                  {'attribution': 'M33 collaboration',
                   'urlPatterns': [ [17, maxZoom, tile_url], ],
                   'maxNativeZoom': maxZoom,});
allLayers.push(tiles);
{% endif %}

tiles = mylayer_B('sdss2', 'SDSS images',
                  {'attribution': sdss_attrib,
                   'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);

{% if enable_ps1 %}
tiles = mylayer_B('ps1', 'PS1 images',
                  {'attribution': ps1_attrib,
                   'urlPatterns': [ [8, maxZoom, tile_url], ],});
                  //'urlPatterns': [ [14, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}

tiles = mylayer_B('hsc', 'HSC DR1 images',
                  {//'attribution': sdss_attrib,
                   'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);


tiles = mylayer_B('hsc2', 'HSC DR2 images',
                  {//'attribution': sdss_attrib,
                   'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);


{% if enable_vlass %}
tiles = mylayer_B('vlass', 'VLASS images',
                  {'attribution': 'NRAO',
                   'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endif %}

tiles = mylayer_B('unwise-w1w2', 'unWISE W1/W2',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [11, maxZoom, tile_url], ],});
allLayers.push(tiles);

tiles = mylayer_B('unwise-neo2', 'unWISE W1/W2 NEO2',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [11, maxZoom, tile_url], ],});
allLayers.push(tiles);

tiles = mylayer_B('unwise-neo3', 'unWISE W1/W2 NEO3',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [10, maxZoom, tile_url], ],});
allLayers.push(tiles);

tiles = mylayer_B('unwise-neo4', 'unWISE W1/W2 NEO4',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [6, maxZoom, tile_url], ],});
                 //'urlPatterns': [ [9, maxZoom, tile_url], ],});
allLayers.push(tiles);

tiles = mylayer_B('unwise-cat-model', 'unWISE Catalog Model',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [6, maxZoom, tile_url], ],});
allLayers.push(tiles);

{% comment %}
tiles = mylayer('2mass', '2MASS',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [1, maxZoom, tile_url], ],});
allLayers.push(tiles);
{% endcomment %}

tiles = mylayer_B('galex', 'GALEX',
                {'maxNativeZoom': 12,
                 'urlPatterns': [ [10, maxZoom, tile_url], ],});
allLayers.push(tiles);

tiles = mylayer_B('sfd', 'SFD dust map',
                {'maxNativeZoom':10,
                 'urlPatterns': [ [7, 10, tile_url],], });
allLayers.push(tiles);

tiles = mylayer_B('wssa', 'WISE 12-micron dust map',
                {'maxNativeZoom':10,
                 'urlPatterns': [ [9, 10, tile_url],], });
allLayers.push(tiles);

tiles = mylayer_B('halpha', 'Halpha map',
                {'maxNativeZoom':10,
                 'urlPatterns': [ [7, 10, tile_url],],});
allLayers.push(tiles);


var added = false;
var layer_name = layer_initial;
var baseMaps = {};
//console.log('Requested layer: "' + layer_name + '"');
for (var i in allLayers) {
    var layer = allLayers[i];
    baseMaps[layer.pretty] = layer;
    //console.log('vs layer name "' + layer.name + '"');
    if (layer_name == layer.name) {
        layer.addTo(map);
        added = true;
    }
}
if (!added) {
    defaultTile.addTo(map);
}
// may be overridden by 'qstr' below.
var last_layer_name = layer_name;

function doGoto() {
    ra  = $('#gotora').val();
    dec = $('#gotodec').val();
    zoom = $('#gotozoom').val();
    console.log('RA ' + ra + ', Dec ' + dec + ', Zoom ' + zoom);
    ra = parseFloat(ra);
    dec = parseFloat(dec);
    zoom = parseInt(zoom);
    console.log('RA ' + ra + ', Dec ' + dec + ', Zoom ' + zoom);
    map.setView(L.latLng(dec2lat(dec), ra2long_C(ra, 0)), zoom);
}

function submitGoto(e) {
    console.log('submit goto ' + typeof(e) + getkeys(e));
    e.stopPropagation();
    doGoto();
}

function cancelGoto(e) {
    console.log('cancel goto ' + typeof(e));
    infoBoxActive = true;
    onMouseMove({ latlng: map.getCenter() });
    e.stopPropagation();
}

function gotoKeypress(e) {
    if (e.which == 13) {
	    // Enter key
	    doGoto();
    }
}

function infoBoxClicked(e) {
    console.log('Info box clicked');
    if (!infoBoxActive) {
	    return;
    }
    infoBoxActive = false;
    ra  = long2ra(map.getCenter().lng);
    dec = lat2dec(map.getCenter().lat);
    ra = ra.toFixed(4);
    // trim trailing zeros
    while (ra.length && ra.charAt(ra.length-1) == '0') {
	    ra = ra.substring(0, ra.length-1);
    }
    dec = dec.toFixed(4);
    while (dec.length && dec.charAt(dec.length-1) == '0') {
	    dec = dec.substring(0, dec.length-1);
    }

    info._div.innerHTML = '<center><form>RA,Dec '
	    + '<input name="ra"  id="gotora"  value="' + ra
	    + '" size=6>, '
	    + '<input name="dec" id="gotodec" value="' + dec
	    + '" size=6>, '
	    + 'zoom <input name="zoom" id="gotozoom" value="' + map.getZoom() + '" size=4>'
	    + '<br/><br/>'
	    + '<input type="button" value="Go" id="gotosubmit">'
	    + '<input type="button" value="Cancel" id="gotocancel">'
	    + '</form></center>';
    $('#gotosubmit').click(submitGoto);
    $('#gotocancel').click(cancelGoto);
    $('#gotora').keypress(gotoKeypress);
    $('#gotodec').keypress(gotoKeypress);
    $('#gotozoom').keypress(gotoKeypress);
}

var infoBoxActive = true;
var info = L.control({'position':'topleft'});
info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info');
    this._div.innerHTML = 'RA,Dec = ' + ra_initial.toFixed(4) + ", " + dec_initial.toFixed(4) + ", zoom " + zoom_initial;
    return this._div;
};
info.addTo(map);

// from static/leaflet-zoomslider -- add the zoom slider manually so it goes *after* the RA,Dec box.
map.zoomsliderControl = new L.Control.Zoomslider();
map.addControl(map.zoomsliderControl);

var container = info.getContainer();
L.DomEvent
    .disableClickPropagation(container)
    .disableScrollPropagation(container);
L.DomEvent.on(container, 'click', infoBoxClicked);

{% if enable_sql %}
// SQL query input field
var query = L.control({'position':'bottomleft'});
query.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'query');
    this._div.innerHTML = 'SQL catalog query: <input type="text" id="sqlquery" value="rflux > 100" size="50"/> <span id="sqlquery_status"></span>'
    return this._div;
};
query.addTo(map);
{% endif %}

// Named object search field
var objquery = L.control({'position':'bottomleft'});
objquery.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'objquery');
    this._div.innerHTML = 'Jump to object: <input type="text" id="objquery" value="NGC 5614" size="25"/> <span id="objquerystatus"></span>';
    return this._div;
};
objquery.addTo(map);

//FAQ
var faq = L.control({'position':'bottomright'});
faq.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'faq');
    this._div.innerHTML = '<a href="https://djschlegel.wordpress.com/faq-legacy-survey-sky-image/">FAQ</a>';
    return this._div;
};
faq.addTo(map);

// A list of object names mapped to [lat,lng,zoom], for history navgation
var hashLocations = {};

function objQueryLoaded(result) {
    console.log('Result: ' + result);
    if ("error" in result) {
        $('#objquerystatus').html(result["error"]);
        return;
    }
    var ra = result['ra'];
    var dec = result['dec'];
    var lat = dec2lat(dec);
    var lng = ra2long_C(ra, 0.);
    var zoom = map.getZoom();
    map.setView(L.latLng(lat, lng), zoom);
    $('#objquerystatus').html("");
    location.hash = result['name'];
    hashLocations[location.hash] = [lat, lng, zoom];
    console.log('Saved hash location:', location.hash, '=', hashLocations[location.hash]);
}

$(document).ready(function() {

{% if enable_sql %}
    $('#sqlquery').keydown(function(event) {
        // when Enter is hit in the SQL box
        if (event.keyCode == 13) {
            sqlOverlay.newQuery();
            return false;
        }
    });

    // stop event propagation to the map layer
    $('#sqlquery').click(function(event) {
        return false;
    });
{% endif %}

    $('#objquery').keydown(function(event) {
        // when Enter is hit in the Object name search box
        if (event.keyCode == 13) {
            var qstring = $('#objquery').val();
            
            // Check if query is DESI tile
            var splited = qstring.split(" ");
            if (splited.length === 2 && splited[0] === "DESI") {
                window.location.href = window.location.origin +
                                       window.location.pathname +
                                       "?desi_tile=" + splited[1] +
                                       '&layer=' + layer_name +
                                       '&desifoot&desifiber' +
                                       '&zoom=8';
                return;
            }

            // Check if query is BRICK
            if (splited[0] === "BRICK") {
                // Default input syntax: "BRICK 1234p567"
                var brickParam = splited[1];
                // Alternative input syntax: "BRICK 1234 567"
                if (splited.length === 3) {
                    brickParam = splited[1] + parameterizeDec(splited[2]);
                }
                window.location.href = window.location.origin +
                                       window.location.pathname +
                                       "?brick=" + brickParam +
                                       '&layer=' + layer_name;
                return;
            }

            var url = L.Util.template(name_query_url, L.extend({
                obj: qstring,
            }));
            if (qstring.length == 0) {
                url += '&layer=' + layer_name;
            }
            $.getJSON(url, objQueryLoaded);
            $('#objquerystatus').html('Searching...');
            return false;
        }
    });
    // stop event propagation to the map layer
    $('#objquery').click(function(event) {
        return false;
    });

    // stop event propagation to the map layer
    $('#upload').click(function(event) {
        console.log('upload clicked.');
        return false;
    });

    $('#usercat_file').click(function(event) {
        event.stopPropagation();
    });
    $('#usercat_submit').click(function(event) {
        event.stopPropagation();
    });

    // set initial hash location
    var loc = [map.getCenter().lat, map.getCenter().lng, map.getZoom()];
    //console.log('Initial location:', loc);
    {% if galname %}
    location.hash = galname_initial;
    {% endif %}
    hashLocations[location.hash] = loc;
    //console.log('Initial hashLocations:', hashLocations);

});

function onHashChange() {
    console.log('Hash changed to', location.hash);
    if (location.hash in hashLocations) {
        var loc = hashLocations[location.hash];
        console.log('Known hash location:', loc);
        var lat = loc[0];
        var lng = loc[1];
        var zoom = loc[2];
        map.setView(L.latLng(lat, lng), zoom);
    }
}

L.DomEvent.addListener(window, 'hashchange', onHashChange);

var PolygonOverlay = CatalogOverlay.extend({

    initialize: function(name, pretty, kwargs) {
        CatalogOverlay.prototype.initialize.call(this, name, pretty, kwargs);
        if ('doHighlight' in kwargs) {
            this._doHighlight = kwargs['doHighlight'];
        } else {
            this._doHighlight = true;
        }
        this._detail = kwargs['detail']
        this._detail_list = kwargs['detail_list']
        this._highlighted = null;
        this._filled = {};
        this._current = {};
        this._color = 'blue';
    },

    loaded: function(counter, result) {
        // reset current polygon list.
        this._current = {};
        CatalogOverlay.prototype.loaded.call(this, counter, result);
    },

    getLabel: function(json, i) {
        return '';
    },

    getLayer: function(result) {
        var objs = result['polys'];
        //console.log('Received ' + objs.length + ' Objs');
        var drawList = [];
        var clong = map.getCenter().lng;
        for (var i=0, len=objs.length; i<len; i++) {
            var name = objs[i].name;
            var rd = objs[i].radecs;
            var poly = [];
            for (var j=0, plen=rd.length; j<plen; j++) {
                poly.push([dec2lat(rd[j][1]), ra2long_C(rd[j][0], clong)]);
            }
            var color = objs[i].color || this._color;
            var c = L.polygon(poly, {fill:false, color:color, weight:4 });
            c.orig_color = color;
            c.name = name;
            if (this._doHighlight) {
                c.on('mouseover', this.mouseOver.bind(this));
                c.on('mouseout',  this.mouseOut.bind(this));
            }
            drawList.push(c);
            this._current[name] = c;
        }
        return L.layerGroup(drawList);
    },

    mouseOver: function(e) {
        e.target.setStyle({color: 'yellow'});
        var obj = e.target;
        this._highlighted = obj.name;
        // remove other objs from fills
        for (var i=0, len=this._filled.length; i<len; i++) {
            if (this._filled[i] != obj.name) {
                this.unhighlight(this._filled[i]);
            }
        }
        if (!(obj.name in this._filled)) {
            this.highlight(obj);
        }
        inbrickccdUpdate(e);
    },

    unhighlight: function(name) {
        this._group.removeLayer(this._filled[name]);
        delete this._filled[name];
    },

    highlight: function(obj) {
        var cf = L.polygon(obj.getLatLngs(),
                           {fill:true, fillOpacity:0.05, color:'yellow',
                            weight:1});
        this._filled[obj.name] = cf;
        cf.addTo(this._group);
        cf.bringToBack();
    },

    mouseOut: function(e) {
        var obj = e.target;
        obj.setStyle({color: obj.orig_color});
        this._highlighted = null;
        if (obj.name in this._filled) {
            this.unhighlight(obj.name);
        }
        inbrickccdUpdate(e);
    },

    under: function(latlng) {
        var objs = [];
        if (!this._show) {
            return [];
        }
        var geos = [];
        for (var name in this._current) {
            var obj = this._current[name];
            var gj = obj.toGeoJSON();
            gj.properties['name'] = name;
            geos.push(gj);
        }
        var geo = {type:'FeatureCollection', features:geos};
        var leafgeo = L.geoJson(geo);
        var inside = leafletPip.pointInLayer(latlng, leafgeo);
        for (var i=0; i<inside.length; i++) {
            objs.push(inside[i].feature.properties.name);
        }
        if (this._doHighlight) {
            if (this._highlighted != null) {
                if (objs.indexOf(this._highlighted) == -1) {
                    objs.push(this._highlighted);
                }
            }
        }
        return objs;
    },

});

var CircleOverlay = PolygonOverlay.extend({
    getLayer: function(result) {
        var objs = result['objs'];
        //console.log('Received ' + objs.length + ' objs');
        var objList = [];
        var clong = map.getCenter().lng;
        for (var i=0, len=objs.length; i<len; i++) {
            var name = objs[i].name;
	        var meters = 30 * 3600 * objs[i].radius;
            var ra = objs[i].ra;
            var dec = objs[i].dec;
            var latlng = L.latLng(dec2lat(dec), ra2long_C(ra, clong));
            var color = objs[i].color || this._color;
            var c = L.circle(latlng, meters, {fill:false, color:color, weight:5 });
            c.orig_color = color;
            c.name = name;
            if (this._doHighlight) {
                c.on('mouseover', this.mouseOver.bind(this));
                c.on('mouseout',  this.mouseOut.bind(this));
            }
            objList.push(c);
            this._current[name] = c;
        }
        return L.layerGroup(objList);
    },

    highlight: function(obj) {
        var cf = L.circle(obj.getLatLng(), obj.getRadius(),
                           {fill:true, fillOpacity:0.05, color:'yellow',
                            weight:1});
        this._filled[obj.name] = cf;
        cf.addTo(this._group);
        cf.bringToBack();
    },

    under: function(latlng) {
        if (!this._show) {
            return [];
        }
        var objs = [];
        var geos = [];
        for (var name in this._current) {
            var obj = this._current[name];
	        if (latlng.distanceTo(obj.getLatLng()) < obj.getRadius()) {
		        objs.push(obj.name);
	        }
        }
        if (this._doHighlight) {
            if (this._highlighted != null) {
                if (objs.indexOf(this._highlighted) == -1) {
                    objs.push(this._highlighted);
                }
            }
        }
        return objs;
    },

});

var tileWatcher = new TileWatcher();
for (var k in baseMaps) {
    tileWatcher.listenToLayer(baseMaps[k]);
}


var exp_detail_list = function(ov, objs) {
    if (objs.length == 0) { return ''; }
    txt = 'In ' + ov._dr_name + ' Exposures: <ul>'
    //console.log('Highlighted: ' + ov._highlighted);
    for (var j=0; j<objs.length; j++) {
        //console.log(' exposure: ' + objs[j]);
        var aparams = '';
        if (objs[j] == ov._highlighted) {
            aparams = ' class="highexp"';
        }
        txt += '<li>' + exp_detail(ov._url_name, objs[j], aparams) + '</li>';
    }
    txt += '</ul>';
    //console.log('Text: ' + txt);
    return txt;
};

var ccd_detail_list = function(ov, objs) {
    if (objs.length == 0) { return ''; }
    txt = 'In ' + ov._dr_name + ' CCDs: <ul>'
    for (var j=0; j<objs.length; j++) {
        var aparams = '';
        if (objs[j] == ov._highlighted) {
            aparams = ' class="highexp"';
        }
        txt += '<li>' + ccd_detail(ov._url_name, objs[j], aparams) + '</li>';
    }
    txt += '</ul>';
    return txt;
};

var sdss_ccd_detail_list = function(ov, objs) {
    if (objs.length == 0) { return ''; }
    txt = 'In ' + ov._dr_name + ' CCDs: <ul>'
    for (var j=0; j<objs.length; j++) {
        var aparams = '';
        if (objs[j] == ov._highlighted) {
            aparams = ' class="highexp"';
        }
        txt += '<li>' + sdss_ccd_detail(ov._url_name, objs[j], aparams) + '</li>';
    }
    txt += '</ul>';
    return txt;
};

var plate_detail_list = function(ov, objs) {
    if (objs.length == 0) { return ''; }
    txt = 'In SDSS Spectro Plates: <ul>';
    for (var j=0; j<objs.length; j++) {
        var aparams = '';
        if (objs[j] == ov._highlighted) {
            aparams = ' class="highexp"';
        }
        txt += '<li>' + plate_detail(ov._url_name, objs[j], aparams) + '</li>';
    }
    txt += '</ul>';
    return txt;
};


{% if enable_dr4_overlays %}
var ccdOverlay4 = new PolygonOverlay('mzls+bass-dr4-ccds',
                                     'MzLS+BASS DR4 CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccds4',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': 'mzls+bass-dr4',
                                     'dr_name': 'DR4',
                                    });
{% endif %}

{% if enable_dr5_overlays %}
var ccdOverlay5 = new PolygonOverlay('decals-dr5-ccds',
                                     'DECaLS DR5 CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccds5',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': 'decals-dr5',
                                     'dr_name': 'DR5',
                                    });
var expOverlay5 = new CircleOverlay('decals-dr5-exps',
                                    'DECaLS DR5 Exposures',
                                    {'url':exposures_url,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'exps5',
                                     'detail': exp_detail,
                                     'detail_list': exp_detail_list,
                                     'url_name': 'decals-dr5',
                                     'dr_name': 'DR5',
                                    });
{% endif %}

{% if enable_dr6_overlays %}
var ccdOverlay6 = new PolygonOverlay('mzls+bass-dr6-ccds',
                                     'MzLS+BASS DR6 CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccds6',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': 'mzls+bass-dr6',
                                     'dr_name': 'DR6',
                                    });
{% endif %}

{% if enable_dr8_overlays %}
var ccdOverlay8 = new PolygonOverlay('dr8-ccds',
                                     'Legacy Surveys DR8 CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccds8',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': 'dr8',
                                     'dr_name': 'DR8',
                                    });
{% endif %}

{% if enable_dr8_north_overlays %}
var ccdOverlay8n = new PolygonOverlay('dr8-north-ccds',
                                     'Legacy Surveys DR8-north CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccds8n',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': 'dr8-north',
                                     'dr_name': 'DR8',
                                    });
{% endif %}

{% if enable_dr8_south_overlays %}
var ccdOverlay8s = new PolygonOverlay('dr8-south-ccds',
                                     'Legacy Surveys DR8-south CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccds8s',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': 'dr8-south',
                                     'dr_name': 'DR8',
                                    });
var expOverlay8s = new CircleOverlay('dr8-south-exps',
                                    'Legacy Surveys DR8-south Exposures',
                                    {'url':exposures_url,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'exps8',
                                     'detail': exp_detail,
                                     'detail_list': exp_detail_list,
                                     'url_name': 'dr8-south',
                                     'dr_name': 'DR8',
                                    });
{% endif %}


                                                     
var brickOverlay = new PolygonOverlay('decals-bricks', 'Legacy Surveys Bricks',
                                      {'url': bricks_url,
                                       'minZoom': 1,
                                       'labelMinZoom': 100,
                                       'doHighlight': false,
                                       'urlTerm': 'bricks',
                                       'detail': brick_detail,
                                       'detail_list': function(ov, objs) {
    if (objs.length == 0) { return ''; }
    txt = 'In: '
    for (var j=0; j<objs.length; j++) {
        txt += brick_detail(ov._url_name, objs[j], '');
    }
    return txt;
},
});


var unwise_tile_detail = function(layer_name, name, aparams) {
    return 'Tile: ' + name;
    //<a href="{% url 'brick_detail_blank' %}' + name
    //+ '/?layer=' + layer_name + '">' + name + '</a>';
    //return '';
}
var unwise_tile_detail_list = function(ov, objs) {
    if (objs.length == 0) { return ''; }
    txt = 'In: '
    var nin = 0;
    for (var j=0; j<objs.length; j++) {
        if (nin > 0)
            txt += ', ';
        txt += unwise_tile_detail(ov._url_name, objs[j], '');
        nin += 1;
    }
    return txt;
    //return '';
}
    
var unwiseTileOverlay = new PolygonOverlay('unwise-tiles',
                                 'unWISE tiles',
                                 {'url':ccds_url,
                                 'minZoom': 6,
                                 'labelMinZoom': 100,
                                 'urlTerm': 'unwise_tile',
                                 'detail': unwise_tile_detail,
                                 'detail_list': unwise_tile_detail_list,
                                 'url_name': 'unwise-tiles',
                                 'dr_name': 'unWISE',
                                 });
unwiseTileOverlay._color = '#9040f0';


var ccdOverlaySdss = new PolygonOverlay('sdss-ccds',
                                 'SDSS CCDs',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': 'ccdssdss',
                                     'detail': sdss_ccd_detail,
                                     'detail_list': sdss_ccd_detail_list,
                                     'url_name': 'sdss',
                                     'dr_name': 'SDSS',
                                    });



{% if enable_spectra %}
url = sdss_plates_url;
if ('plate' in qstr) {
    url += '&plate=' + qstr['plate'];
}
var plateOverlay = new CircleOverlay('sdss-plates',
                                     'SDSS Spectro Plates',
                                    {'url': url,
                                     'labelMinZoom': 100,
                                     'detail': plate_detail,
                                     'detail_list': plate_detail_list,
                                    });
{% endif %}

{% comment %}
These are overlays that have entries when you click on the map,
and entries in the "in brick/ccd" panel.
{% endcomment %}

var polygonOverlays = [ 
    {% if enable_dr4_overlays %}
    ccdOverlay4,
    {% endif %}
    {% if enable_dr5_overlays %}
    ccdOverlay5, expOverlay5,
    {% endif %}
    {% if enable_dr6_overlays %}
    ccdOverlay6,
    {% endif %}
    {% if enable_dr7_overlays %}
    ccdOverlay7, expOverlay7,
    {% endif %}
    {% if enable_dr8_overlays %}
    ccdOverlay8,
    {% endif %}
    {% if enable_dr8_north_overlays %}
    ccdOverlay8n,
    {% endif %}
    {% if enable_dr8_south_overlays %}
    ccdOverlay8s, expOverlay8s,
    {% endif %}
    brickOverlay,
    unwiseTileOverlay,
    ccdOverlaySdss,
    {% if enable_spectra %}
    plateOverlay,
    {% endif %}
];

for (var i=0; i<polygonOverlays.length; i++) {
    polygonOverlays[i].on('loaded', function() { inbrickccdUpdate(); });
}

{% if enable_dr4_overlays %}
var mzlsbasscat4 = new DecalsCatalogLayer(tileWatcher,
                                          'mzls+bass-dr4',
                                          'MzLS+BASS DR4 Catalog',
                                          {'url': cat_url,
                                           'minZoom': 12,
                                           'urlTerm': 'sources-dr4'});
{% endif %}

{% if enable_dr5_overlays %}
var decalscat5 = new DecalsCatalogLayer(tileWatcher,
                                        'decals-dr5',
                                        'DECaLS DR5 Catalog',
                                        {'url': cat_url,
                                         'minZoom': 12,
                                         'urlTerm': 'sources-dr5'});
{% endif %}

{% if enable_dr6_overlays %}
var mzlsbasscat6 = new DecalsCatalogLayer(tileWatcher,
                                          'mzls+bass-dr6',
                                          'MzLS+BASS DR6 Catalog',
                                          {'url': cat_url,
                                           'minZoom': 12,
                                           'urlTerm': 'sources-dr6'});
{% endif %}

{% if enable_dr8_overlays %}
var dr8cat = new DecalsCatalogLayer(tileWatcher,
                                    'dr8',
                                    'Legacy Surveys DR8 Catalog',
                                    {'url': cat_url,
                                     'minZoom': 12,
                                     'urlTerm': 'sources-dr8'});
{% endif %}

{% if enable_dr8_north_overlays %}
var dr8northcat = new DecalsCatalogLayer(tileWatcher,
                                        'dr8-north',
                                          'Legacy Surveys DR8-north Catalog',
                                          {'url': cat_url,
                                           'minZoom': 12,
                                           'urlTerm': 'sources-dr8n'});
{% endif %}
{% if enable_dr8_south_overlays %}
var dr8southcat = new DecalsCatalogLayer(tileWatcher,
                                        'dr8-south',
                                          'Legacy Surveys DR8-south Catalog',
                                          {'url': cat_url,
                                           'minZoom': 12,
                                           'urlTerm': 'sources-dr8n'});
{% endif %}

var bright = new BrightCatalog('bright', 'Bright stars', {});

var tycho2 = new CatalogOverlay('tycho2', 'Tycho-2 stars', {});

{% if enable_ps1 %}
var ps1cat = new Ps1CatalogOverlay('ps1-cat', 'PS1 catalog', {'radius':150});
{% endif %}

var gals = new GalaxyCatalog('gals', 'NGC/IC galaxies',
                             {'url_name': 'ngc',
                              'minZoom': 5,
                              'labelsMinZoom': 7,
                             'urlTerm': 'ngc',});


var lslga = new LSLGACatalog('lslga', 'LSLGA (large galaxies)',
                             {'minZoom': 5,
                              'labelsMinZoom': 7,
                              'urlTerm': 'lslga',});

var GaiaDr1Catalog = CatalogOverlay.extend({
    getColor: function(json, i) {
        return '#bbbbff';
    }
});

var gaia = new GaiaDr1Catalog('gaia-dr1', 'Gaia DR1 catalog',
                             {'url_name': 'gaia-dr1',
                              'minZoom': 11,
                              'labelsMinZoom': 99,
                              'urlTerm': 'gaia-dr1',
                              'radius': 260, });

var GaiaDr2Catalog = CatalogOverlay.extend({
    getColor: function(json, i) {
        return '#8888ff';
    },

    getLabel(json, i) {
        var ra = json['rd'][i][0];
        var dec = json['rd'][i][1];
        var txt = 'RA,Dec ' + ra.toFixed(4) + ', ' + dec.toFixed(4);
        var pmra = json['pmra'][i];
        var pmdec = json['pmdec'][i];
        var parallax = json['parallax'][i];
        var pmra_err = json['pmra_err'][i];
        var pmdec_err = json['pmdec_err'][i];
        var parallax_err = json['parallax_err'][i];
        if (pmra != 0.0) {
            txt = txt + '<br>pmRA,Dec ' + pmra.toFixed(1) + ', ' + pmdec.toFixed(1) +
                                        ' &pm; ' + pmra_err.toFixed(1) + ', ' + pmdec_err.toFixed(1) + ' mas/yr, ' +
                                        'parallax ' + parallax.toFixed(1) + '&pm; ' + parallax_err.toFixed(1) + ' mas';
        }
        txt = txt + '<br>G ' + json['gmag'][i].toFixed(2) + ', BP ' + json['bpmag'][i].toFixed(2) + ', RP ' + json['rpmag'][i].toFixed(2);
        txt = txt + '<br>Source id: ' + json['sourceid'][i];
        return txt;
    },

    getTooltipStyle() {
        return { permanent: false, interactive: true, };
    },

});

var gaia2 = new GaiaDr2Catalog('gaia-dr2', 'Gaia DR2 catalog',
                             {'url_name': 'gaia-dr2',
                              'minZoom': 11,
                              'labelsMinZoom': 11,
                              'urlTerm': 'gaia-dr2',
                              'radius': 220,
                              //'color': '#ddddff'
                              });


var SdssCatalog = CatalogOverlay.extend({

    getColor: function(json, i) {
        if (json['sourcetype'][i] == 'P') {
            return '#9AFE2E';
        }
        return '#888888';
    },

    getLabel(json, i) {
        return '';
    },

    getPopupText(json, i) {
        var ra = json['rd'][i][0];
        var dec = json['rd'][i][1];
        var txt = 'RA,Dec ' + ra.toFixed(4) + ', ' + dec.toFixed(4);
        if (json['sourcetype'][i] == 'P') {
            var tt = 'PSF';
        } else {
            var tt = 'CModel';
        }
        txt = txt + '<br>' + tt + ' mags: ';
        txt += 'u=' + fluxToMag(json['fluxes'][i]['u']).toFixed(2) + ', ';
        txt += 'g=' + fluxToMag(json['fluxes'][i]['g']).toFixed(2) + ', ';
        txt += 'r=' + fluxToMag(json['fluxes'][i]['r']).toFixed(2) + ', ';
        txt += 'i=' + fluxToMag(json['fluxes'][i]['i']).toFixed(2) + ', ';
        txt += 'z=' + fluxToMag(json['fluxes'][i]['z']).toFixed(2);
        //txt = txt + '<br>Source id: ' + json['sourceid'][i];
        return txt;
    },

    getTooltipStyle() {
        return { permanent: false, interactive: true, };
    },
    
});

var sdsscat = new SdssCatalog('sdss-cat', 'SDSS catalog',
                             {'url_name': 'sdss-cat',
                              'minZoom': 11,
                              'labelsMinZoom': 11,
                              'urlTerm': 'sdss-cat',
                              'radius': 100,
                              });

{% if enable_phat %}
var phat_clusters = new PhatClusterCatalog('phat-clusters', 'PHAT clusters',
                             {'url_name': 'phat-clusters',
                              'minZoom': 11,
                              'labelsMinZoom': 99,
                              'urlTerm': 'phat-clusters',
                              'radius': 150, });
{% endif %}

{% if enable_desi_targets %}
var desi_targets45 = new DesiTargetCatalog('targets-dr45', 'DESI Targets (DR4/DR5)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

var desi_targets67 = new DesiTargetCatalog('targets-dr67', 'DESI Targets (DR6/DR7)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

var desi_bgs_targets67 = new DesiTargetCatalog('targets-bgs-dr67', 'DESI BGS Targets (DR6/DR7)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

var desi_bright_targets67 = new DesiTargetCatalog('targets-bright-dr67', 'DESI Bright-time Targets (DR6/DR7)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

var desi_dark_targets67 = new DesiTargetCatalog('targets-dark-dr67', 'DESI Dark-time Targets (DR6/DR7)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

var desi_sky_targets67 = new DesiTargetCatalog('targets-sky-dr67', 'DESI Sky Targets (DR6/DR7)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

var desi_cmx_targets7 = new DesiTargetCatalog('targets-cmx-dr7', 'DESI Commissioning Targets (DR7)',
                                  {'radius': 200,
                                   'labelsMinZoom': 11,
                                   'minZoom': 11, });

{% endif %}

{% if enable_spectra %}
url = smallcat_url;
if ('plate' in qstr) {
    url += '&plate=' + qstr['plate'];
}
var spec = new SdssSpectraCatalog('spec', 'SDSS Spectra',
                                  {'url': url,
                                   'radius': 300,
                                   'labelsMinZoom': 11,
                                   'minZoom': 8,
                                   'urlTerm': 'spectra'});

var specDeep2 = new Deep2SpectraCatalog('spec-deep2', 'DEEP2 Spectra',
                                  {'radius': 100,
                                   'labelsMinZoom': 11,
                                   'minZoom': 9,
                                   'urlTerm': 'spectra-deep2'});
{% endif %}

{% if enable_sql %}
var sqlOverlay = new SqlCatalogOverlay('sql', 'SQL query',
                                       {'url': sql_url, 'radius': 300,});
{% endif %}

// Constellations
var conGroup = L.layerGroup([]);
var constellations = {
    _name: 'constellations',
    _pretty: 'Constellations',
    getGroup: function() { return conGroup; },
    getLinkHere: function() { return 'constellations'; },
    initLinkHere: function(val) {},
};

// DESI Footprint
// from gfa-corners.fits from Bailey, 2019-03-18
var petal_radius = [
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059],
    [1.54426530072, 1.5999816327800001, 1.6054123220500001, 1.54995479059]
];
var petal_phi = [
    [287.31935812, 287.34502698699998, 283.02060759099999, 282.82671929999998],
    [323.31935812, 323.34502698699998, 319.02060759099999, 318.82671929999998],
    [359.31935812, 359.34502698699998, 355.02060759099999, 354.82671929999998],
    [35.319358120399997, 35.345026987399997, 31.020607590600001, 30.826719299699999],
    [71.319358120399997, 71.345026987400004, 67.020607590599994, 66.826719299700002],
    [107.31935812, 107.345026987, 103.020607591, 102.82671929999999],
    [143.31935812, 143.34502698700001, 139.02060759099999, 138.82671930000001],
    [179.31935812, 179.34502698700001, 175.02060759099999, 174.82671930000001],
    [215.31935812, 215.34502698700001, 211.02060759099999, 210.82671930000001],
    [251.31935812, 251.34502698700001, 247.02060759099999, 246.82671930000001]
];
var desi_radius=1.6274810767584347;

// Commissioning instrument CCDs
//CIW: RA,Dec boundaries relative to boresight (0,0):
var ci_radecs = {'CIW':
                 [[-1.60636765, -1.5335968 , -1.5335968 , -1.60636765],
                  [-0.0503096, -0.0503096,  0.0488675,  0.0488675]],
                 'CIS':
                 [[5.46111024e-02, 5.46093498e-02, -5.30440012e-02, -5.30457037e-02],
                  [-1.60352809, -1.53643771, -1.53643775, -1.60352813]],
                 'CIC':
                 [[-5.68333564e-02, -5.68333564e-02, 5.52042579e-02, 5.52042579e-02],
                  [ 0.03787655, -0.03791358, -0.03791358,  0.03787655]],
                 'CIN':
                 [[-5.46111024e-02, -5.46093498e-02,5.30440012e-02, 5.30457037e-02],
                  [1.60352809, 1.53643771, 1.53643775, 1.60352813]],
                 'CIE':
                 [[1.60636765, 1.5335968 , 1.5335968 , 1.60636765],
                  [ 0.0503096,  0.0503096, -0.0488675, -0.0488675]],
                };

var desiLocationStack = [];

var DesiOverlay = CatalogOverlay.extend({
    ready: function() {
        CatalogOverlay.prototype.ready.call(this);
    },
    overlayAdded: function(e) {
        if (!layerMatchesEvent(this, e)) {
            return;
        }
        this._show = true;

        var latlng;
        if (desiLocationStack.length > 0) { // If a previous DesiOverlay is being displayed
            latlng = desiLocationStack[0];  // set latlng to its location
        } else if (this._got_initial_position) { // If radec is specified by url
            latlng = L.latLng(dec2lat(this.dec), ra2long_C(this.ra, 180))
        } else {
            latlng = map.getCenter();
        }

        this.moveTo(latlng);
        desiLocationStack.push(latlng);
        this._group.addLayer(this._layer);
    },
    overlayRemoved: function(e) {
        CatalogOverlay.prototype.overlayRemoved.call(this, e);
        if (layerMatchesEvent(this, e)) {
            desiLocationStack.pop();
        }
    },
    load: function() {
    },
    getLinkHere: function() {
        return this._url_term + '=' + this.ra.toFixed(4) + ',' + this.dec.toFixed(4);
    },
    initLinkHere: function(val) {
        if (typeof val !== String) {
            this._show = true;
            return;
        }
        words = val.split(',');
        if (words.length != 2) {
            return;
        }
        var r = Number.parseFloat(words[0]);
        var d = Number.parseFloat(words[1]);
        this.ra = r;
        this.dec = d;
        this._show = true;
        this._got_initial_position = true;
    },
})

var DesiFiberPos = DesiOverlay.extend({
    initialize: function(name, pretty, kwargs) {
        DesiOverlay.prototype.initialize.call(this, name, pretty, kwargs);
        this._layer = L.layerGroup([]);
    },
    moveTo: function(c) {
        var clong = c.lng
        var d0 = lat2dec(c.lat);
        var r0 = long2ra(clong);
        this.ra = r0;
        this.dec = d0;

        if (this._show) {
            // Create worker if worker does not exist
            if (!this._worker) {
                this._worker = new Worker('{% static "desi_worker.js" %}');
                var _this = this;
                this._worker.addEventListener('message', function(e) {
                    var polyline = L.polyline(e.data, {color: 'DeepSkyBlue', smoothFactor: 0.5, opacity: 0.2});
                    // Remove the previous fiberpos layer if exists
                    if (_this._fiberpos) {
                        _this._layer.removeLayer(_this._fiberpos);
                        _this._fiberpos = undefined;
                    }
                    // Discard result if desi footprint is not being displayed
                    if (_this._show) {
                        _this._fiberpos = polyline;
                        _this._layer.addLayer(_this._fiberpos);
                    }
                    // Update displayed status
                    _this._status && _this._status.html('');
                }, false);
            }
            // Tell worker to initiate calculation
            this._worker.postMessage([r0, d0, clong]);
            this._status && this._status.html('calculating...');
        }
    },
    overlayRemoved: function(e) {
        DesiOverlay.prototype.overlayRemoved.call(this, e);
        if (layerMatchesEvent(this, e)) {
            if (this._fiberpos) {
                this._layer.removeLayer(this._fiberpos);
                this._fiberpos = undefined;
            }
            this._show = false;
        }
    },
});

var DesiFootprint = DesiOverlay.extend({
    initialize: function(name, pretty, kwargs) {
        DesiOverlay.prototype.initialize.call(this, name, pretty, kwargs);
        this._got_initial_position = false;
        var group = [];
        var clong = 180;
        this._circle = L.circle(L.latLng(dec2lat(0), ra2long_C(0, clong)),
                                arcsecToMeters(desi_radius * 3600.),
                                {color:'yellow', fill:false}); //fillOpacity:0.01});
        group.push(this._circle);
        this._gfa_rds = [];
        var polys = [];
        for (var i=0; i<petal_radius.length; i++) {
            var ll = [];
            var rd = [];
            var N = petal_radius[i].length;
            for (var j=0; j<N+1; j++) {
                var phi = petal_phi[i][j%N] * Math.PI / 180.0;
                var ddec = petal_radius[i][j%N] * Math.sin(phi);
                // This ra was flipped positive to make the positions look right,
                // but I don't understand why this is necessary
                // -- Mark
                var dra  = petal_radius[i][j%N] * Math.cos(phi);
                rd.push([dra, ddec]);
                ll.push([dec2lat(ddec), ra2long_C(dra, clong)]);
            }
            this._gfa_rds.push(rd);
            polys.push(ll);
        }
        this._gfa = L.polyline(polys, {color: 'green'});
        group.push(this._gfa);

        this._ci_rds = [];
        polys = [];
        for (var k in ci_radecs) {
            var rrdd = ci_radecs[k];
            var ll = [];
            var rd = [];
            var N = rrdd[0].length;
            for (var j=0; j<N+1; j++) {
                var dra  = rrdd[0][j%N];
                var ddec = rrdd[1][j%N];
                rd.push([dra, ddec]);
                ll.push([dec2lat(ddec), ra2long_C(dra, clong)]);
            }
            this._ci_rds.push(rd);
            polys.push(ll);
        }
        this._ci = L.polyline(polys, {color: 'magenta'});
        group.push(this._ci);

        this._layer = L.layerGroup(group);
        //map.on('mapMoved', this.mapMoved.bind(this));
    },
    ready: function() {
        DesiOverlay.prototype.ready.call(this);
        this._gfa.redraw();
    },
    moveTo: function(c) {
        this._circle.setLatLng(c);
        var clong = c.lng;
        var d0 = lat2dec(c.lat);
        var r0 = long2ra(clong);
        this.ra = r0;
        this.dec = d0;
        var cosdec = Math.cos(d0 * Math.PI / 180.0);
        var polys = [];
        for (var i=0; i<this._gfa_rds.length; i++) {
            var ll = [];
            var rd = this._gfa_rds[i];
            var N = rd.length;
            for (var j=0; j<N; j++) {
                ll.push([dec2lat(d0 + rd[j][1]),
                         ra2long_C(r0 + rd[j][0] / cosdec, clong)]);
            }
            polys.push(ll);
        }
        this._gfa.setLatLngs(polys);
        this._gfa.redraw();

        var polys = [];
        for (var i=0; i<this._ci_rds.length; i++) {
            var ll = [];
            var rd = this._ci_rds[i];
            var N = rd.length;
            for (var j=0; j<N; j++) {
                ll.push([dec2lat(d0 + rd[j][1]),
                         ra2long_C(r0 + rd[j][0] / cosdec, clong)]);
            }
            polys.push(ll);
        }
        this._ci.setLatLngs(polys);
        this._ci.redraw();
    },
});
var desifoot = new DesiFootprint('desi-footprint', 'DESI Footprint', {});
desifoot._url_term = 'desifoot';
var desifiber = new DesiFiberPos('desi-fiberpos', 'DESI Fibers', {});
desifiber._url_term = 'desifiber';
// TODO: Make url terms a constant

var overlays = [
    {% if enable_phat %}
    phat_clusters,
    {% endif %}    
    {% if enable_dr4_overlays %}
    mzlsbasscat4,
    {% endif %}
    {% if enable_dr5_overlays %}
    decalscat5,
    {% endif %}
    {% if enable_dr6_overlays %}
    mzlsbasscat6,
    {% endif %}
    {% if enable_dr7_overlays %}
    decalscat7,
    {% endif %}
    {% if enable_dr8_overlays %}
    dr8cat,
    {% endif %}
    {% if enable_dr8_north_overlays %}
    dr8northcat,
    {% endif %}
    {% if enable_dr8_south_overlays %}
    dr8southcat,
    {% endif %}
    {% if enable_dr4_overlays %}
    ccdOverlay4,
    {% endif %}
    {% if enable_dr5_overlays %}
    ccdOverlay5,
    {% endif %}
    {% if enable_dr6_overlays %}
    ccdOverlay6,
    {% endif %}
    {% if enable_dr7_overlays %}
    ccdOverlay7,
    {% endif %}
    {% if enable_dr8_overlays %}
    ccdOverlay8,
    {% endif %}
    {% if enable_dr8_north_overlays %}
    ccdOverlay8n,
    {% endif %}
    {% if enable_dr8_south_overlays %}
    ccdOverlay8s,
    expOverlay8s,
    {% endif %}
    {% if enable_dr5_overlays %}
    expOverlay5,
    {% endif %}
    {% if enable_dr7_overlays %}
    expOverlay7,
    {% endif %}

    brickOverlay,
    unwiseTileOverlay,
    ccdOverlaySdss,
    gals, lslga, bright, tycho2,
    {% if enable_ps1 %}
    ps1cat,
    {% endif %}
    gaia,
    gaia2,
    sdsscat,
    {% if enable_spectra %}
    spec, plateOverlay, specDeep2,
    {% endif %}
    {% if enable_desi_targets %}
    desi_targets45,
    desi_targets67,
    desi_bgs_targets67,
    desi_sky_targets67,
    desi_dark_targets67,
    desi_bright_targets67,
    desi_cmx_targets7,
    {% endif %}
    constellations,
    desifoot,
    desifiber,
];



if ('blink' in qstr) {
    last_layer_name = qstr['blink'];
}

for (k in qstr) {
    console.log('qstring key: ' + k);
}


{% if enable_dev %}
{% for name,pretty in test_ccds %}
var ccds = new PolygonOverlay('{{name}}-ccds', '{{pretty}}',
                                    {'url':ccds_url,
                                     'minZoom': 8,
                                     'labelMinZoom': 100,
                                     'urlTerm': '{{name}}',
                                     'detail': ccd_detail,
                                     'detail_list': ccd_detail_list,
                                     'url_name': '{{name}}',
                                    });
overlays.push(ccds);
{% endfor %}

{% for name,pretty in test_cats %}
  var testcat = new DecalsCatalogLayer(tileWatcher,
                                       '{{name}}', '{{pretty}}',
                                        {'url': cat_url,
                                         'minZoom': 12,
                                         'urlTerm': '{{name}}'});
  overlays.push(testcat);
{% endfor %}
{% endif %}



var namedLayers = {};
for (var i in allLayers) {
    var layer = allLayers[i];
    //console.log('layer.name ' + layer.name + ' pretty ' + layer.pretty);
    namedLayers[layer.name] = layer;
}

 // var findlayer = function(name, children=undefined) {
function findlayer(name, children=[]) {
    rtn = { label: namedLayers[name].pretty, layer: namedLayers[name] };
    if (children.length) {
        rtn['children'] = children;
    }
    return rtn;
}
 
var testTree = [];
{% if enable_dev %}
{% for name,pretty in test_layers %}
  testTree.push(findlayer('{{name}}'));
{% endfor %}
{% endif %}

console.log('testTree:', testTree);

var baseTree1 = [
    {% if enable_m33 %}
    findlayer('m33'),
    {% endif %}
    {% if enable_phat %}
    findlayer('phat'),
    {% endif %}
    {% if enable_dr8 %}
    findlayer('dr8', [
        findlayer('dr8-model'),
        findlayer('dr8-resid'),
    ]),
    {% endif %}
    {% if enable_dr8_north %}
    findlayer('dr8-north', [
        findlayer('dr8-north-model'),
        findlayer('dr8-north-resid'),
    ]),
    {% endif %}
    {% if enable_dr8_south %}
    findlayer('dr8-south', [
        findlayer('dr8-south-model'),
        findlayer('dr8-south-resid'),
    ]),
    {% endif %}
    {% if enable_dr67 %}
    findlayer('ls-dr67'),
    {% endif %}
    {% if enable_dr7 %}
    findlayer('decals-dr7', [
        findlayer('decals-dr7-model'),
        findlayer('decals-dr7-resid'),
    ]),
    {% endif %}
    {% if enable_dr6 %}
    //{
    findlayer('mzls+bass-dr6', [
        findlayer('mzls+bass-dr6-model'),
        findlayer('mzls+bass-dr6-resid'),
    ]),
    {% endif %}
    {% if enable_dr5 %}
    findlayer('decals-dr5', [
        {% if enable_dr5_model %}
        findlayer('decals-dr5-model'),
        {% endif %}
        {% if enable_dr5_resid %}
        findlayer('decals-dr5-resid'),
        {% endif %}
    ]),
    {% endif %}
    {% if enable_dr4 %}
    findlayer('mzls+bass-dr4', [
        {% if enable_dr4_model %}
        findlayer('mzls+bass-dr4-model'),
        {% endif %}
        {% if enable_dr4_resid %}
        findlayer('mzls+bass-dr4-resid'),
        {% endif %}
    ]),
    {% endif %}
    {% if enable_eboss %}
    findlayer('eboss'),
    {% endif %}
    {% if enable_decaps %}
    findlayer('decaps', [
        findlayer('decaps-model'),
        findlayer('decaps-resid'),
    ]),
    {% endif %}
    findlayer('unwise-neo4', [
        findlayer('unwise-neo3'),
        findlayer('unwise-neo2'),
        findlayer('unwise-w1w2'),
    ]),
    findlayer('unwise-cat-model'),
    {
        label: 'More surveys',
        children: [
            findlayer('sdss2'),
            {% if enable_des_dr1 %}
            findlayer('des-dr1'),
            {% endif %}
            {% if enable_ps1 %}
            findlayer('ps1'),
            {% endif %}
            findlayer('hsc'),
            findlayer('hsc2'),
            {% if enable_vlass %}
            findlayer('vlass'),
            {% endif %}
            {% comment %}
            findlayer('2mass'),
            {% endcomment %}
            findlayer('galex'),
            findlayer('wssa'),
            findlayer('sfd'),
            findlayer('halpha'),
        ],
    },
];

var baseTree = [];
for (var x in testTree) {
  baseTree.push(testTree[x]);
}
for (var x in baseTree1) {
  baseTree.push(baseTree1[x]);
}

console.log('baseTree:', baseTree);

var namedOverlays = {};
for (var i=0,len=overlays.length; i<len; i++) {
    namedOverlays[overlays[i]._name] = overlays[i];
    // The '.getGroup()' object is the one passed into the overlay tree, so
    // tag a name onto it.
    group = overlays[i].getGroup();
    group._name = overlays[i]._name;
}

 function findoverlay(name, children=[]) {
     rtn =  { label: namedOverlays[name]._pretty,
              layer: namedOverlays[name].getGroup() };
     if (children.length) {
         rtn['children'] = children;
     }
     return rtn;
 }

 var overlayTree = [];

 overlayTree = overlayTree.concat([
     findoverlay('gals'),
     findoverlay('constellations'),
 ]);

 /*
var layerControl = new L.control.layers(baseMaps, {}, { collapsed: false })
for (var i=0,len=overlays.length; i<len; i++) {
    layerControl._addLayer(overlays[i].getGroup(), overlays[i]._pretty, true);
}
layerControl._addLayer(conGroup, 'Constellations', true);
layerControl.addTo(map);
*/

L.control.layers.tree(baseTree, overlayTree, { collapsed: false }).addTo(map);

 $(document).ready(function() {
     // This is fragile wrt the DOM structure of the tree layer control widget.
     var sel = $(".leaflet-layerstree-opened").parent().parent();
     //console.log('Parents:');
     //console.log(sel);
     
     txts = [
         {% if enable_dr7 %}
         'LegacySurvey DR6+DR7 images',
         {% endif %}
         'MzLS+BASS DR4 images',
         'DECaLS DR5 images',
         'DECaPS images',
         'unWISE W1/W2 NEO4',
         'DECaLS DR7 catalog',
         'DECaLS DR7 CCDs',
         'DECaLS DR7 Exposures',
         'Other catalogs',
         'Spectroscopy',
         'DESI targets',
            ];

     for (var i=0,len=txts.length; i<len; i++) {
         var txt = txts[i];
         var sel = $(".leaflet-layerstree-header").filter(":contains('" + txt + "')");
         sel = sel.children().children().filter(".leaflet-layerstree-opened");
         sel.trigger('click');
     }
 });
 
/*
  The overlays DOM looks like this:

  <div class="leaflet-control-layers-overlays">
  <label>
  <input class="leaflet-control-layers-selector" type="checkbox">
  <span> Sources</span>
  </label>
  <label>
  <input class="leaflet-control-layers-selector" type="checkbox">
  <span> Bricks</span>
  </label>
  <label>
  </div>
*/
// We iterate through the <input> tags, getting the text from the next sibling.
function getOverlayCheckbox(name) {
    var ov = false;
    var ovs = $('.leaflet-control-layers-overlays .leaflet-control-layers-selector');
    ovs.each(function(i) {
        var o = $(this);
        var text = $.trim(o.next().text());
        //console.log('Looking for overlay "' + name + '", found "' + text + '"');
        if (text == name) {
            ov = o;
        }
    });
    return ov;
}

function onMapZoomEnd(e) {
    // update the RA,Dec,zoom info box
    if (typeof(lastLatLng) != 'undefined') {
        onMouseMove({ latlng: lastLatLng });
    }
}

map.setView([ dec2lat(dec_initial), ra2long_C(ra_initial, 180.) ], zoom_initial);
var lastLatLng = map.getCenter();

{% if enable_sql %}
map.addLayer(sqlOverlay.getGroup());
{% endif %}

if ('mark' in qstr) {
    var coords = qstr['mark'];
    coords = coords.split(';');
    //console.log('coords: ' + coords.length);
    var clong = map.getCenter().lng;
    var circleList = new Array(coords.length);
    for (var i=0; i<coords.length; i++) {
        var words = coords[i].split(',');
        var r = Number.parseFloat(words[0]);
        var d = Number.parseFloat(words[1]);
        var lat = dec2lat(d);
        var lng = ra2long_C(r, clong);
        var rad = arcsecToMeters(5.);
        var color = 'yellow';
        var circ = L.circle([lat, lng], rad,
                            {'color':color, 'fillOpacity':0, 'weight':5});
        circleList[i] = circ;
    }
    var lg = L.layerGroup(circleList);
    map.addLayer(lg);
}

console.log('adding layers from qstr');
for (var i=0,len=overlays.length; i<len; i++) {
    ov = overlays[i]
    if (ov._url_term in qstr) {
        console.log('adding layer ' + ov._url_term + ', ' + ov._pretty);
        ov.initLinkHere(qstr[ov._url_term]);
        map.addLayer(ov.getGroup());
    }
}
console.log('done adding layers from qstr');

if ('constel' in qstr) {
  map.addLayer(conGroup);
}

map.on('mousemove', onMouseMove);
map.on('overlayadd', overlayAdded);
map.on('overlayremove', overlayRemoved);
map.on('click', onMapClick);
map.on('zoomend', onMapZoomEnd);

map.on('moveend', function(e) {
    console.log('moveend');
    buildConstellations();
});

map.on('baselayerchange', function(e) {
    console.log('baselayerchange: ' + e);
    console.log('layer: ' + e.layer);
    console.log('layer_name: ' + e.layer.name);
    last_layer_name = layer_name;
    layer_name = e.layer.name;
    console.log('new layer_name: ' + layer_name + ', new last_layer_name: ' + last_layer_name);
});

// When space bar is pressed, switch back to previous layer.  This allows a quick "blink" between layers.
function keyDown(e) {
    //console.log('keyDown ' + e + ' keycode ' + e.keyCode + ', char ' + e.char + ' charCode ' + e.charCode);
    //console.log('objquery has focus? ' + $('#objquery').is(":focus"));

    if ($('#objquery').is(":focus")) {
        return;
    }

    // space bar
    if (e.keyCode == 32) {
        //console.log('space bar!');
        //console.log('layer_name ' + layer_name + ', last_layer_name ' + last_layer_name);
        if (last_layer_name != layer_name) {
            console.log('Switching from layer ' + layer_name + ' back to previous layer ' + last_layer_name);
            var toadd = false;
            var torm  = false;
            for (i in allLayers) {
                layer = allLayers[i];
                if (layer_name == layer.name) {
                    torm = layer;
                } else if (last_layer_name == layer.name) {
                    toadd = layer;
                }
            }
            if (toadd && torm) {
                torm.removeFrom(map);
                toadd.addTo(map);
            }
        }
        e.preventDefault();
        e.stopPropagation();
    }
}
document.addEventListener('keydown', keyDown);
//map.getContainer().addEventListener('keypress', keyDown);


// These are from Astrometry.net's stellarium_constellations.c

var constellation_shortnames =  [ "Aql","And","Scl","Ara","Lib","Cet","Ari","Sct","Pyx","Boo","Cae","Cha","Cnc","Cap","Car","Cas","Cen","Cep","Com","Cvn","Aur","Col","Cir","Crt","CrA","CrB","Crv","Cru","Cyg","Del","Dor","Dra","Nor","Eri","Sge","For","Gem","Cam","CMa","UMa","Gru","Her","Hor","Hya","Hyi","Ind","Lac","Mon","Lep","Leo","Lup","Lyn","Lyr","Ant","Mic","Mus","Oct","Aps","Oph","Ori","Pav","Peg","Pic","Per","Equ","CMi","LMi","Vul","UMi","Phe","Psc","PsA","Vol","Pup","Ret","Sgr","Sco","Ser","Sex","Men","Tau","Tel","Tuc","Tri","Tra","Aqr","Vir","Vel" ];

var constellation_longnames = [ "Aquila", "Andromeda", "Sculptor", "Ara", "Libra", "Cetus", "Aries", "Scutum", "Pyxis", "Bootes", "Caelum", "Chamaeleon", "Cancer", "Capricornus", "Carina", "Cassiopeia", "Centaurus", "Cepheus", "Coma Berenices", "Canes Venatici", "Auriga", "Columba", "Circinus", "Crater", "Corona Austrina", "Corona Borealis", "Corvus", "Crux", "Cygnus", "Delphinus", "Dorado", "Draco", "Norma", "Eridanus", "Sagitta", "Fornax", "Gemini", "Camelopardalis", "Canis Major", "Ursa Major", "Grus", "Hercules", "Horologium", "Hydra", "Hydrus", "Indus", "Lacerta", "Monoceros", "Lepus", "Leo", "Lupus", "Lynx", "Lyra", "Antlia", "Microscopium", "Musca", "Octans", "Apus", "Ophiuchus", "Orion", "Pavo", "Pegasus", "Pictor", "Perseus", "Equuleus", "Canis Minor", "Leo Minor", "Vulpecula", "Ursa Minor", "Phoenix", "Pisces", "Piscis Austrinus", "Volans", "Puppis", "Reticulum", "Sagittarius", "Scorpius", "Serpens", "Sextans", "Mensa", "Taurus", "Telescopium", "Tucana", "Triangulum", "Triangulum Australe", "Aquarius", "Virgo", "Vela" ];

//'","'.join(['#%02x%02x%02x' % (x[0],x[1],x[2]) for x in (np.random.randint(128, size=(88,3))+128)])
var constellation_colors = ["#90d581","#e1f093","#d18693","#f5ea94","#96d495","#93abaf","#d49eac","#b2f9b1","#ab9cd5","#e4a9dc","#bfa6d1","#b2faee","#eaa8cb","#8d82aa","#96cfde","#f7a5f2","#e5d6cf","#d5f483","#8785d4","#87f3b7","#fea7b4","#b4f0b2","#ce84c7","#bdf3b8","#aa9898","#8cbc91","#dcecd5","#c4c5ee","#deb7e4","#efed9c","#b0d4eb","#b9e9d9","#b4c3c6","#92c0a6","#d8fe84","#bfc4d3","#89a3f0","#c2c19c","#b384f9","#fdb1cc","#beb4d2","#b1bcf3","#bfeca9","#f4b2b1","#9492e0","#efd590","#90b6c2","#d19a81","#c6d781","#def7cd","#9cd581","#ab8199","#d0fdd4","#b9b4d3","#f6cdde","#85aeba","#cb9ad3","#81859d","#cedf93","#95f495","#aabeba","#c5f5a6","#aca4b3","#a2e0ab","#8c8bc5","#dceac2","#f4ddcd","#d0c785","#d5f58a","#c5fafe","#a595be","#e6f6ab","#e2eddf","#96f4b8","#fea5a2","#aaf3e3","#9da4a5","#dff99b","#f3c1ce","#b484c4","#9cf6d4","#c2c6bc","#8ff5a7","#9d8be4","#9e9ac3","#f5eb99","#d3d9d2","#f6cff3"];

var constellation_lines = [
    [582,579,579,576,579,568,568,580,591,580,568,555,555,551,568,556],
    [0,11,11,24,47,24,24,17,17,15],
    [685,18,18,681,681,685],
    [516,496,496,480,480,475,475,494,494,491,491,490,490,516],
    [444,432,432,419,419,412,412,416,416,432],
    [50,57,35,13,13,4,13,23,23,27,27,37,37,55,55,62,62,68,68,59,59,35,53,62,53,61,61,67,67,78,78,77,77,69,69,57,57,60,60,67],
    [72,48,48,43,43,39],
    [537,538,538,542,542,529,529,531,531,537],
    [256,261,261,267],
    [404,395,395,408,408,418,418,415,415,400,400,399,399,395,395,387,387,384],
    [120,126,126,127],
    [248,314,314,352],
    [264,260,260,249,260,262,262,247,262,269],
    [592,593,593,611,611,619,619,625,625,630,619,622,622,611,593,603,611,608],
    [277,302,302,316,316,317,317,325,325,321,321,311,311,305,305,279,258,250,250,197,276,279,276,258,197,203,250,242],
    [42,28,28,16,16,12,12,1],
    [403,391,391,382,382,388,388,389,389,386,386,385,385,380,380,377,385,393,386,401,401,414,388,365,365,356,356,346,346,335,335,336],
    [642,666,666,623,623,617,617,642,666,686,686,623],
    [374,375,375,355],
    [362,371],
    [180,179,179,148,148,140,140,138,153,138,153,180],
    [193,190,190,177,177,171,171,178,171,163,163,155],
    [406,425,406,420],
    [322,327,327,332,332,330,330,322,330,331,331,337,337,345,345,338,338,332],
    [534,546,546,549,549,557,557,560,560,561,561,559,559,553,553,545,534,530],
    [428,427,427,429,429,434,434,439,439,447,447,451],
    [359,357,357,351,351,348,348,347,348,363,363,357],
    [358,354,368,349],
    [563,570,570,575,575,594,594,600,594,604,604,613,613,627,594,583,583,571],
    [596,597,597,599,599,605,605,601,601,597],
    [166,173,173,159,159,166,159,121,121,111],
    [511,513,513,492,492,498,498,511,511,562,562,578,578,522,522,482,482,462,462,452,452,426,426,392,392,361,361,333],
    [456,460,460,463,463,453,453,460,453,456],
    [33,44,44,52,52,56,56,64,64,66,66,76,76,87,87,99,99,101,101,113,113,116,116,122,122,97,97,92,92,86,86,79,79,70,70,75,75,85,85,91,91,94,94,124,124,130,130,134,134,142,142,143,143,125],
    [574,577,577,573,577,584,584,589],
    [71,84],
    [202,219,219,228,228,227,227,206,228,235,235,239,235,240,235,230,230,222,222,234,222,210,222,204,204,199,204,195,195,189,189,183],
    [90,104,104,136,90,102,102,136,102,151],
    [211,218,218,213,213,205,205,217,217,220,220,224,224,229,215,216,216,220,216,212,212,201,201,200,201,194,201,205,215,208,192,215,213,211],
    [383,378,378,369,369,350,350,324,324,323,323,344,344,350,344,341,341,326,326,306,326,308,323,293,293,288,288,273,288,270,293,291,291,253,253,286,286,324],
    [675,650,650,638,638,659,659,677,677,675,659,672,659,664,638,635,635,632],
    [503,512,512,489,489,487,487,486,486,471,471,467,467,459,459,443,471,470,470,465,465,461,470,481,481,493,493,485,508,514,514,517,514,508,481,486],
    [109,65,65,80],
    [259,255,255,254,254,265,265,266,266,259,266,268,268,278,278,287,287,284,284,283,283,292,292,301,301,309,309,319,319,334,334,343,343,373,373,376],
    [7,98,98,63,63,54,54,45],
    [618,598,598,609,609,618],
    [643,652,652,651,651,648,648,647,647,654,654,651],
    [188,198,198,223,223,196,196,186,223,245,245,237],
    [184,176,176,167,167,158,158,145,158,172,172,165,165,154,154,141,158,154,145,149,145,146,141,145,146,144,149,150],
    [342,329,329,300,300,297,297,307,307,328,328,342,307,304,304,294,294,290,328,329],
    [442,455,455,449,449,442,449,431,431,423,423,424,423,413,431,433,433,417,417,405,417,402,405,397,405,413],
    [281,280,280,274,274,271,271,251,251,231,231,214,214,191],
    [532,535,535,539,539,550,550,541,541,535],
    [310,296],
    [616,610,610,607],
    [367,339,339,360,360,364,364,367],
    [626,661,661,398,398,626],
    [410,466,466,472],
    [500,506,483,506,500,479,479,458,458,469,469,483,483,495],
    [164,161,161,157,182,187,187,185,185,174,187,181,181,175,175,164,164,169,169,147,147,157,157,152,152,160,160,175,152,131,131,133,133,135,135,139,131,132,132,137,185,181],
    [595,621,621,602,602,590,590,595,590,586,586,533,533,547,547,590,547,540,540,524,524,518,518,540,518,507],
    [3,674,673,660,660,639,673,667,667,662,662,637,637,629,674,663,663,658,658,641,641,628,0,673,0,3],
    [207,170,170,168],
    [96,103,103,107,107,105,105,93,93,88,88,81,81,74,88,83,83,82,82,73],
    [612,614,614,620,620,615,615,612],
    [236,232],
    [320,312,312,298,298,289,298,320],
    [569,587],
    [58,497,497,473,473,435,435,457,457,422,422,411,411,435],
    [22,21,21,8,8,22,21,31,31,41,41,21,21,29,29,8,8,9,9,2,2,8],
    [19,25,19,26,26,25,25,32,32,36,36,46,46,40,40,34,34,30,30,20,20,14,14,6,6,689,689,687,687,688,688,683,683,679,679,684,684,687],
    [671,657,657,633,633,631,631,640,640,655,655,670],
    [238,221,221,244,244,238,244,225,244,252,252,272,272,244],
    [243,241,241,226,226,203,203,209,209,233,233,242,242,243],
    [110,112,112,106,106,95,95,110],
    [521,527,520,525,525,515,515,509,515,521,521,525,525,552,552,536,536,521,536,527,527,519,552,558,558,543,543,536,543,548,548,554,554,564,564,565,558,572,572,588,588,585,585,581,581,567,581,566],
    [499,505,505,510,510,501,501,484,484,478,478,477,477,476,476,468,468,464,464,450,464,448,464,454],
    [440,441,441,436,436,430,430,437,437,446,446,438,438,437,544,523,523,504,504,502,502,488],
    [313,299],
    [156,129],
    [153,128,128,118,123,162,114,115,114,108,108,89,123,118,123,119,119,114,118,117,117,115,115,100],
    [528,526],
    [645,680,680,5,680,10],
    [51,49,49,38,38,51],
    [474,421,421,445,445,474],
    [624,634,634,646,646,649,649,656,656,668,668,678,678,682,634,644,644,636,644,653,653,665,665,669,669,676,606,624],
    [340,353,353,366,366,379,379,394,394,396,396,407,379,381,381,390,390,409,381,370,370,372,370,366],
    [246,257,257,263,263,282,282,295,295,318,318,315,315,303,303,285,285,275,275,246]];

var constellation_stars = [2.09654,29.0908,2.29204,59.1502,2.35225,-45.747,3.30896,15.1836,4.857,-8.82383,5.00796,-64.8776,5.14942,8.19025,6.41333,-77.255,6.5505,-43.6799,6.57029,-42.3051,7.88567,-62.9581,9.83167,30.8612,10.1266,56.5374,10.8968,-17.9867,12.0722,7.29992,12.4535,41.0789,14.1771,60.7168,14.1879,38.4992,14.6515,-29.3575,15.7045,31.8043,15.7361,7.89008,16.5213,-46.7185,17.0961,-55.2458,17.1469,-10.1819,17.4325,35.6208,18.4373,24.5838,19.8666,27.2641,21.006,-8.18275,21.4525,60.2354,22.0914,-43.3177,22.5456,6.14394,22.8124,-49.0731,22.8708,15.3458,24.4281,-57.2367,25.358,5.48761,26.0214,-15.9396,26.3483,9.15764,27.865,-10.3349,28.2704,29.5794,28.3824,19.2941,28.3889,3.18747,28.4117,-46.3024,28.5987,63.6701,28.6598,20.8083,28.9868,-51.6096,29.6911,-61.5699,30.5117,2.76375,30.9747,42.3299,31.7929,23.4628,32.3855,34.9874,33.25,8.84675,33.9846,33.359,34.1271,-51.5121,34.8366,-2.97706,35.4376,-68.6594,36.4875,-12.2904,36.7462,-47.7038,37.0397,8.46008,37.9462,89.2641,38.022,-15.2443,38.9687,5.59331,39.8706,0.328528,39.8905,-11.8716,39.8968,-68.2669,39.9497,-42.8916,40.1649,-54.5499,40.1664,-39.8553,40.8255,3.23617,41.0306,-13.8587,41.2349,10.1142,41.2749,-18.5726,42.2723,-32.4063,42.4958,27.2608,42.6455,38.3189,42.6741,55.8955,44.1067,-8.89761,44.5655,-40.3047,44.9287,8.90739,45.5938,4.35286,45.5983,-23.6243,45.9038,-59.7376,46.1991,53.5064,46.2938,38.8405,47.0422,40.9556,48.0178,-28.9891,48.9585,-8.81983,49.879,-21.7579,49.9717,-43.0716,51.0806,49.8613,51.2035,9.02906,52.2672,59.9403,53.2351,-9.45831,53.4469,-21.6328,55.7312,47.7877,55.8123,-9.76519,56.0481,-64.8071,56.0797,32.2883,56.7125,-23.2484,56.8093,-74.2393,57.1493,-37.6201,57.2905,24.0535,57.3637,-36.2001,57.5895,71.3324,58.533,31.8837,59.356,63.0723,59.4634,40.0103,59.6864,-61.4001,59.7412,35.791,60.1701,12.4904,63.5003,-42.2939,63.606,-62.474,64.0062,-51.4871,64.1212,-59.3018,64.4734,-33.7983,64.948,15.6277,65.7335,17.5426,66.009,-34.017,66.3722,17.928,67.1539,19.1805,67.1653,15.8709,67.7087,-44.9538,68.4988,-55.045,68.8878,-30.5623,68.98,16.5098,69.0797,-3.35244,69.5453,-14.3036,70.1409,-41.8636,70.5144,-37.1448,70.5613,22.957,70.7665,-70.9311,71.3756,-3.25461,72.4589,6.96125,72.653,8.90025,72.8015,5.60511,73.2237,-5.45275,73.3448,2.50828,73.5125,66.3427,73.7237,10.1511,74.2484,33.1661,74.6371,1.71403,75.6195,41.0759,76.3652,-22.3709,76.9626,-5.08625,77.2866,-8.75408,78.0745,-11.8691,78.2328,-16.2054,78.3079,-12.9413,78.6345,-8.20164,79.1721,45.999,79.8939,-13.1768,79.996,-12.3156,80.6407,79.2308,81.2828,6.34972,81.5729,28.6079,82.0614,-20.7592,82.8031,-35.4704,82.9694,-76.3417,83.0017,-0.299083,83.1825,-17.8223,83.4063,-62.4899,83.7845,9.93417,84.0534,-1.20192,84.4112,21.1426,84.9123,-34.0741,85.1897,-1.94258,86.1165,-22.4475,86.1934,-65.7355,86.739,-14.8219,86.8212,-51.0667,86.9391,-9.66961,87.4566,-56.1665,87.7398,-35.7693,87.8298,-20.8775,88.5246,-63.091,88.5962,20.2764,88.7929,7.40703,89.1013,-14.168,89.3842,-35.2833,89.7866,-42.8151,89.8824,44.9474,89.9302,37.2128,90.5958,9.64736,90.864,19.6906,91.0301,23.2636,91.5389,-14.9353,91.893,14.7685,92.2412,2.49972,92.985,14.2088,93.7139,-6.27472,93.7196,22.5068,94.1381,-35.1407,94.9058,59.0109,95.0783,-30.0634,95.5285,-33.4363,95.675,-17.9559,95.74,22.5139,95.9421,4.59283,95.9879,-52.6957,97.2045,-7.03306,97.2408,20.2122,98.7641,-22.9648,99.1708,-19.2557,99.4279,16.3994,99.4403,-43.1959,100.983,25.1312,101.289,-16.7131,101.323,12.8961,102.048,-61.942,102.46,-32.5085,102.484,-50.6144,103.197,33.9614,103.548,-12.0386,103.554,-23.9284,104.034,-17.0543,104.319,58.4231,104.656,-28.9721,105.43,-27.9348,105.756,-23.8333,105.94,-15.6333,106.027,20.5703,107.098,-26.3932,107.187,-70.4992,107.785,30.2453,107.966,-0.492778,108.703,-26.7727,109.208,-67.9572,109.286,-37.0975,109.523,16.5405,110.031,21.9823,111.024,-29.3031,111.432,27.7983,111.679,49.2116,111.788,8.28942,112.308,-43.3019,113.65,31.8886,113.981,26.896,114.827,5.2275,115.312,-9.55108,115.455,-72.6061,116.112,24.3981,116.331,28.0263,117.257,-24.9123,120.896,-40.0032,121.886,-24.3044,121.983,-68.6171,122.149,-2.98378,122.383,-47.3366,124.129,9.18567,124.63,-76.92,125.016,27.2186,125.629,-59.5095,125.709,43.1884,126.434,-66.1365,127.567,60.7184,129.414,5.70381,129.689,3.34147,130.026,-35.3083,130.073,-52.922,130.154,-59.761,130.806,3.39867,130.822,21.4686,130.898,-33.1864,131.171,18.1549,131.176,-54.7086,131.674,28.76,131.694,6.41892,132.108,5.83789,132.633,-27.7101,133.849,5.94553,134.622,11.8578,134.804,48.0424,135.161,41.7834,135.612,-66.3958,135.907,47.1567,136.632,38.4523,136.999,-43.4326,137.742,-58.9669,138.301,-69.7175,138.591,2.31503,139.273,-59.2752,139.711,36.8029,140.264,34.3925,140.528,-55.0107,141.897,-8.65869,142.287,-2.76894,142.675,-40.4669,142.882,63.0618,142.996,-1.18467,143.218,51.6786,143.556,36.3976,146.463,23.7743,147.749,59.0391,147.869,-14.8466,148.026,54.0643,148.192,26.0071,149.216,-54.5678,149.718,-35.8909,151.833,16.7627,151.857,35.2447,151.985,-0.371639,152.094,11.9672,152.648,-12.3538,153.435,-70.0379,153.684,-42.1221,154.173,23.4173,154.271,-61.3323,154.275,42.9145,154.992,19.8419,155.582,41.4994,156.523,-16.8361,156.788,-31.0678,156.97,-58.7394,156.971,36.7075,157.573,-0.636972,158.868,-78.6078,159.326,-48.2256,160.739,-64.3945,160.885,-60.5666,161.692,-49.4201,162.406,-16.1941,163.328,34.2156,163.373,-58.8533,164.945,-18.2991,165.46,56.3823,165.933,61.7511,167.147,-58.9751,167.416,44.4986,167.915,-22.8256,168.527,20.524,168.56,15.4298,169.836,-14.7791,171.153,-10.8594,171.221,-17.684,172.851,69.3311,173.251,-31.8575,173.69,-54.2641,173.946,-63.0198,174.171,-9.80225,176.191,-18.3506,176.402,-66.7288,176.465,6.52981,176.513,47.7793,177.266,14.5723,178.227,-33.9081,178.457,53.6947,179.004,-17.1508,182.09,-50.7224,182.103,-24.7288,182.531,-22.6198,183.787,-58.7489,183.856,57.0326,183.952,-17.542,184.587,-79.3123,184.668,-0.787139,186.65,-63.0991,186.735,28.2686,187.01,-50.2306,187.467,-16.5151,187.791,-57.1126,188.019,-16.1959,188.117,-72.133,188.371,69.7882,188.438,41.3568,188.597,-23.3966,189.296,-69.1355,190.38,-48.9599,190.417,-1.44953,191.57,-68.1081,191.93,-59.6887,193.507,55.9598,193.902,3.39761,194.008,38.3182,195.545,10.9591,197.264,-23.118,197.498,17.5291,197.97,27.876,199.73,-23.1714,200.15,-36.7121,200.981,54.9254,201.298,-11.1613,202.761,-39.4073,203.674,-0.595944,204.972,-53.4664,206.886,49.3133,207.37,15.7978,207.376,-41.6877,207.404,-42.4737,208.671,18.3986,208.885,-47.2883,209.67,-44.8035,210.412,1.54458,210.956,-60.373,211.098,64.3758,211.672,-36.3687,213.224,-10.2741,213.918,19.1873,214.004,-5.99953,216.545,-45.3792,216.732,-83.6679,217.958,30.3711,218.02,38.3079,218.877,-42.1577,219.472,-49.4258,219.92,-60.8351,220.287,13.7283,220.482,-47.3881,220.628,-64.9746,220.765,-5.65742,221.247,27.0742,221.562,1.89294,221.966,-79.0447,222.677,74.1555,222.72,-16.0416,224.633,-43.1339,224.79,-42.1041,225.487,40.3906,226.018,-25.2819,228.072,-52.0991,228.875,33.3151,229.252,-9.38286,229.379,-58.8009,229.728,-68.6795,230.182,71.834,230.343,-40.6475,230.452,-36.2612,230.844,-59.3207,231.232,58.966,231.958,29.1055,233.232,31.3592,233.672,26.7149,233.701,10.5389,233.785,-41.1667,233.881,-14.7896,234.514,-42.5675,235.686,26.2955,236.014,77.7945,236.067,6.42553,236.547,15.4219,237.185,18.1418,237.399,26.0686,237.405,-3.43014,237.704,4.47758,237.74,-33.6271,238.167,42.45,238.456,-16.7296,238.787,-63.4297,239.112,15.6647,239.397,26.878,239.713,-26.1141,240.031,-38.3966,240.083,-22.6216,240.361,29.8511,240.474,58.5644,240.804,-49.2297,241.359,-19.8054,241.817,-36.7555,243.37,-54.6304,244.377,75.7547,244.58,-4.69261,244.935,46.3133,244.961,-50.1554,245.48,19.153,245.998,61.5141,246.796,-47.5547,247.352,-26.4319,247.555,21.4896,248.364,-78.897,248.526,42.4369,248.971,-28.216,249.29,-10.5671,250.323,31.6019,250.724,38.9225,250.773,-77.5166,251.492,82.0372,252.166,-69.0276,252.446,-59.0413,252.543,-34.2926,252.968,-38.0473,253.499,-42.362,254.418,9.37506,254.655,-55.9901,255.073,30.9263,257.197,65.7146,257.594,-15.7251,258.038,-43.2385,258.758,24.8396,258.762,36.8092,259.418,37.2913,260.207,-12.8469,260.921,37.1459,261.325,-55.5298,261.349,-56.3777,262.608,52.3014,262.685,26.1106,262.775,-60.6836,262.854,-23.9626,262.961,-49.876,263.054,86.5863,263.066,55.1728,263.402,-37.1037,263.733,12.5606,264.33,-42.9978,264.397,-15.3984,264.866,46.0063,265.354,-12.8752,265.622,-39.0299,265.868,4.56692,266.433,-64.7237,266.615,27.7225,266.89,-27.8307,266.896,-40.127,268.382,56.8724,269.063,37.2505,269.152,51.4889,269.441,29.2479,271.452,-30.4236,271.658,-50.0914,271.886,28.7625,272.145,-63.6681,273.441,-21.0588,274.407,-36.7613,275.248,-29.828,275.26,72.7337,275.329,-2.89711,275.807,-61.4939,276.043,-34.3843,276.743,-45.9683,276.993,-25.4212,277.207,-49.07,277.299,-14.5658,278.089,-39.7039,278.802,-8.24331,279.234,38.783,280.759,-71.4277,280.946,-38.3233,281.193,37.6051,281.414,-26.9908,281.794,-4.74783,281.871,-5.70508,282.52,33.3627,283.054,-62.1876,283.626,36.8986,283.68,-15.603,283.816,-26.2966,284.055,4.20353,284.071,-42.7106,284.169,-37.3432,284.238,-67.2335,284.432,-21.1066,284.681,-37.1071,284.736,32.6896,284.906,15.0685,285.653,-29.8801,285.778,-42.095,286.171,-21.7414,286.353,13.8637,286.562,-4.88233,286.604,-37.0628,286.735,-27.6698,287.087,-40.4966,287.368,-37.9043,287.507,-39.3407,288.138,67.6613,289.275,53.3682,289.409,-18.9529,290.418,-17.8472,290.804,-44.7996,290.971,-40.6156,291.374,3.11458,292.177,24.6652,292.426,51.7295,292.68,27.9597,294.007,-24.719,295.024,18.0139,295.262,17.4761,296.244,45.1307,296.565,10.6133,296.847,18.5343,297.043,70.2678,297.695,8.86739,298.118,1.00567,298.815,-41.8684,298.828,6.40794,299.077,35.0835,299.689,19.4921,299.934,-35.2762,300.147,-72.9102,300.275,27.7536,300.664,-27.7099,301.289,19.9909,302.174,-66.1793,302.826,-0.821472,304.513,-12.5449,305.253,-14.7814,305.557,40.2567,306.412,-56.7349,308.303,11.3033,309.387,14.5952,309.392,-47.2917,309.771,15.8382,310.358,45.2803,310.865,15.0747,311.24,-66.2032,311.524,-25.2705,311.552,33.9694,311.665,16.1248,311.919,-9.49569,312.492,-33.7797,312.955,-26.9191,313.702,-58.4541,315.323,-32.2578,316.487,-17.2327,317.585,10.1319,318.234,30.2271,318.62,10.0077,318.956,5.24808,319.484,-32.1725,319.644,62.5854,319.966,-53.4493,320.562,-16.8346,320.723,6.81111,321.61,-65.3681,321.667,-22.4114,322.165,70.5607,322.89,-5.57117,325.022,-16.6623,325.369,-77.3895,326.035,28.7432,326.046,9.875,326.161,25.645,326.76,-16.1266,326.934,-30.8983,328.482,-37.3648,330.209,-28.4538,331.446,-0.319833,331.529,-39.5431,331.609,-13.8695,331.752,25.3451,332.058,-46.9606,332.307,33.1725,332.535,-32.5484,332.549,6.19778,332.714,58.2012,333.992,37.7487,334.208,-7.78325,334.626,-60.2595,335.414,-1.38736,335.89,52.2295,336.129,49.4764,337.207,-0.0200556,337.317,-43.4956,337.383,47.7069,337.622,43.1234,337.662,-10.6779,337.822,50.2824,337.876,-32.346,338.839,-0.117361,340.164,-27.0436,340.365,10.8314,340.666,-46.8846,340.751,30.2213,341.516,-81.3816,341.633,23.5657,341.673,12.1741,342.138,-51.3167,342.398,-13.5925,342.42,66.2007,342.5,24.6017,343.154,-7.57967,343.663,-15.8208,343.987,-32.5397,344.412,-29.6218,345.22,-52.7541,345.943,28.0824,346.19,15.2054,346.72,-43.5203,347.361,-21.1725,347.589,-45.2466,348.972,-9.08769,349.29,3.28225,349.358,-58.2359,349.706,-32.5318,350.743,-20.1003,351.733,1.25583,351.992,6.37911,353.242,-37.8184,354.837,77.632,354.987,5.62736,355.512,1.78042,359.828,6.86358];

var buildConstellations = function() {
    //console.log('buildConstellations()');
    conGroup.clearLayers();
    for (var i in constellation_lines) {
        //console.log('Constellation ' + constellation_shortnames[i]);
        var lines = constellation_lines[i];
        var latlngs = [];
        var clong = map.getCenter().lng;
        var s1 = lines[0];
        var ra1  = constellation_stars[2*s1];
        var long1 = ra2long_C(ra1, clong);
        // duplicate this constellation if the viewpoint is wider than 360 degrees?
    
        for (var j=0; j<lines.length/2; j++) {
    	    var s1 = lines[2*j];
    	    var s2 = lines[2*j+1];
    	    var ra1  = constellation_stars[2*s1];
    	    var dec1 = constellation_stars[2*s1+1];
    	    var ra2  = constellation_stars[2*s2];
    	    var dec2 = constellation_stars[2*s2+1];
            var latlng1 = L.latLng(dec2lat(dec1), ra2long_C(ra1, long1));
            var latlng2 = L.latLng(dec2lat(dec2), ra2long_C(ra2, long1));
    	    latlngs.push([ latlng1, latlng2 ]);
            //if (i == 0) console.log('  line from star ' + s1 + ' to ' + s2 + ', ra,dec ' + ra1 + ',' + dec1 + ' to ' + ra2 + ',' + dec2 + '; latlng ' + latlng1 + ' to ' + latlng2);
        }
        var mpl = L.polyline(latlngs, {'color': constellation_colors[i]});
        conGroup.addLayer(mpl);

        // add a fake Circle marker to hold the label.
        // compute center of mass of stars in this constellation
        ustars = new Set(lines);
        //console.log('Constellation ' + constellation_longnames[i] + ': ' + ustars.size + ' ustars');
        var xc = 0.;
        var yc = 0.;
        var decc = 0.;
        ustars.forEach(function(s) {
            var ra  = Math.PI / 180. * constellation_stars[2*s];
            var dec = Math.PI / 180. * constellation_stars[2*s+1];
            xc += Math.cos(dec) * Math.cos(ra);
            yc += Math.cos(dec) * Math.sin(ra);
            decc += constellation_stars[2*s+1];
        });
        xc /= (ustars.size + 0.0);
        yc /= (ustars.size + 0.0);
        ra  = 180. / Math.PI * Math.atan2(yc, xc);
        dec = decc / (ustars.size + 0.0);

        var latlng = L.latLng(dec2lat(dec), ra2long_C(ra, long1));
        var circ = L.circle(latlng, 0., {'color':'red', 'opacity':0.,
                                         'fillOpacity':0, 'weight':5});
        circ.bindTooltip(constellation_longnames[i],
                         {interactive: true, permanent: true,
                          direction: 'center' });
        conGroup.addLayer(circ);
    }
};

buildConstellations();


// A scale bar that shows arcsec / arcmin / degrees rather than meters
var AstroControl = L.Control.Scale.extend({
    options: {
	    imperial: false,
	    maxWidth: 300,
    },
    _updateMetric: function (maxMeters) {
	    // meters -> arcsec
	    var maxArcsec = maxMeters / 30.87;
	    var maxUnit = maxArcsec;
	    var unitName = 'arcsec';

	    if (maxArcsec > 7200) {
	        // degrees
	        maxUnit /= 3600;
	        unitName = 'deg';
	    } else if (maxArcsec >= 180) {
	        // arcmin
	        maxUnit /= 60;
	        unitName = 'arcmin';
	    }
	    var unit = this._getRoundNum(maxUnit);
        var ratio = unit/maxUnit;
		this._mScale.style.width = Math.round(this.options.maxWidth * ratio) + 'px';
	    this._mScale.innerHTML = unit + ' ' + unitName;
    },

    // Yep, astronomers even have different ideas about what numbers are round.
    // _getRoundNum: function (num) {
    // 	var pow10 = Math.pow(10, (Math.floor(num) + '').length - 1),
    // 	d = num / pow10;
    // 	d = d >= 10 ? 10 : d >= 5 ? 5 : d >= 3 ? 3 : d >= 2 ? 2 : 1;
    // 	return pow10 * d;
    // }

});

new AstroControl().addTo(map);

{% comment %}
AstroPolylineMeasure = L.Polyline.Measure.extend({
});
AstroMeasureControl = L.Control.MeasureControl.extend({
    onAdd: function(map) {
        var className = 'leaflet-control-draw';
        this._container = L.DomUtil.create('div', 'leaflet-bar');
	    
	    // This is the only line changed --
        this.handler = new AstroPolylineMeasure(map, this.options.handler);

        this.handler.on('enabled', function () {
            L.DomUtil.addClass(this._container, 'enabled');
        }, this);
        this.handler.on('disabled', function () {
            L.DomUtil.removeClass(this._container, 'enabled');
        }, this);
        var link = L.DomUtil.create('a', className+'-measure', this._container);
        link.href = '#';
        link.title = L.Control.MeasureControl.TITLE;
        L.DomEvent
            .addListener(link, 'click', L.DomEvent.stopPropagation)
            .addListener(link, 'click', L.DomEvent.preventDefault)
            .addListener(link, 'click', this.toggle, this);
        return this._container;
    }
});
//new AstroMeasureControl().addTo(map);
{% endcomment %}

</script>
</body>

{% endblock %}
